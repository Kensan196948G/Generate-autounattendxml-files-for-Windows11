import React, { useState } from 'react'
import styles from '../styles/Home.module.css'

interface ErrorDisplayProps {
  error: any
  sessionId?: string
  onDownloadLogs?: (format: 'json' | 'text') => void
}

const ErrorDisplay: React.FC<ErrorDisplayProps> = ({ error, sessionId, onDownloadLogs }) => {
  const [showDetails, setShowDetails] = useState(false)
  const [showLogs, setShowLogs] = useState(false)

  const formatTimestamp = (timestamp: string) => {
    try {
      return new Date(timestamp).toLocaleString('ja-JP')
    } catch {
      return timestamp
    }
  }

  const copyToClipboard = (text: string) => {
    // Clipboard API„ÅåÂà©Áî®ÂèØËÉΩ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(text)
        .then(() => alert('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü'))
        .catch(() => {
          // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Çí‰ΩøÁî®
          fallbackCopyToClipboard(text)
        })
    } else {
      // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Çí‰ΩøÁî®
      fallbackCopyToClipboard(text)
    }
  }

  const fallbackCopyToClipboard = (text: string) => {
    const textArea = document.createElement('textarea')
    textArea.value = text
    textArea.style.position = 'fixed'
    textArea.style.top = '0'
    textArea.style.left = '0'
    textArea.style.width = '2em'
    textArea.style.height = '2em'
    textArea.style.padding = '0'
    textArea.style.border = 'none'
    textArea.style.outline = 'none'
    textArea.style.boxShadow = 'none'
    textArea.style.background = 'transparent'
    document.body.appendChild(textArea)
    textArea.focus()
    textArea.select()
    
    try {
      const successful = document.execCommand('copy')
      if (successful) {
        alert('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü')
      } else {
        alert('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü')
      }
    } catch (err) {
      console.error('„Ç≥„Éî„Éº„Ç®„É©„Éº:', err)
      alert('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü')
    }
    
    document.body.removeChild(textArea)
  }

  const getErrorMessage = () => {
    if (typeof error === 'string') return error
    if (error?.message) return error.message
    if (error?.detail) return error.detail
    return 'XMLÁîüÊàê„É™„ÇØ„Ç®„Çπ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'
  }

  const getErrorDetails = () => {
    if (error?.response?.data) return error.response.data
    if (error?.data) return error.data
    return error
  }

  const errorDetails = getErrorDetails()

  return (
    <div className={styles.errorContainer} style={{
      backgroundColor: '#fef2f2',
      border: '1px solid #fecaca',
      borderRadius: '8px',
      padding: '16px',
      marginTop: '16px'
    }}>
      <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '12px' }}>
        <span style={{ fontSize: '24px' }}>‚ö†Ô∏è</span>
        <h3 style={{ margin: 0, color: '#991b1b' }}>XMLÁîüÊàê„Ç®„É©„Éº</h3>
      </div>

      <div style={{ marginBottom: '12px' }}>
        <p style={{ margin: '4px 0', color: '#7f1d1d' }}>
          <strong>„É°„ÉÉ„Çª„Éº„Ç∏:</strong> {getErrorMessage()}
        </p>
        
        {errorDetails?.status && (
          <p style={{ margin: '4px 0', color: '#7f1d1d' }}>
            <strong>„Çπ„ÉÜ„Éº„Çø„Çπ:</strong> {errorDetails.status}
          </p>
        )}
        
        {errorDetails?.timestamp && (
          <p style={{ margin: '4px 0', color: '#7f1d1d' }}>
            <strong>„Çø„Ç§„É†„Çπ„Çø„É≥„Éó:</strong> {formatTimestamp(errorDetails.timestamp)}
          </p>
        )}
      </div>

      {/* „Ç®„É©„ÉºË©≥Á¥∞„ÅÆÂ±ïÈñã/Êäò„ÇäÁï≥„Åø */}
      <button
        onClick={() => setShowDetails(!showDetails)}
        style={{
          background: 'none',
          border: 'none',
          color: '#0070f3',
          cursor: 'pointer',
          padding: '8px 0',
          fontSize: '14px',
          display: 'flex',
          alignItems: 'center',
          gap: '4px'
        }}
      >
        {showDetails ? '‚ñº' : '‚ñ∂'} „Ç®„É©„ÉºË©≥Á¥∞„Çí{showDetails ? 'Èö†„Åô' : 'Ë°®Á§∫'}
      </button>

      {showDetails && (
        <div style={{
          backgroundColor: '#fff',
          border: '1px solid #e5e5e5',
          borderRadius: '4px',
          padding: '12px',
          marginTop: '8px',
          fontSize: '13px',
          fontFamily: 'monospace'
        }}>
          {errorDetails?.error && (
            <div style={{ marginBottom: '12px' }}>
              <strong>„Ç®„É©„ÉºË©≥Á¥∞:</strong>
              <pre style={{ 
                margin: '4px 0', 
                whiteSpace: 'pre-wrap', 
                wordBreak: 'break-word',
                backgroundColor: '#f5f5f5',
                padding: '8px',
                borderRadius: '4px'
              }}>
                {typeof errorDetails.error === 'string' 
                  ? errorDetails.error 
                  : JSON.stringify(errorDetails.error, null, 2)}
              </pre>
            </div>
          )}

          {errorDetails?.stack_trace && (
            <div style={{ marginBottom: '12px' }}>
              <strong>„Çπ„Çø„ÉÉ„ÇØ„Éà„É¨„Éº„Çπ:</strong>
              <pre style={{ 
                margin: '4px 0', 
                whiteSpace: 'pre-wrap', 
                wordBreak: 'break-word',
                backgroundColor: '#f5f5f5',
                padding: '8px',
                borderRadius: '4px',
                maxHeight: '200px',
                overflow: 'auto'
              }}>
                {errorDetails.stack_trace}
              </pre>
            </div>
          )}

          <button
            onClick={() => copyToClipboard(JSON.stringify(errorDetails, null, 2))}
            style={{
              backgroundColor: '#f3f4f6',
              border: '1px solid #d1d5db',
              borderRadius: '4px',
              padding: '6px 12px',
              fontSize: '12px',
              cursor: 'pointer',
              marginTop: '8px'
            }}
          >
            üìã Ë©≥Á¥∞„Çí„Ç≥„Éî„Éº
          </button>
        </div>
      )}

      {/* „É≠„Ç∞ÊÉÖÂ†±„ÅÆÂ±ïÈñã/Êäò„ÇäÁï≥„Åø */}
      {errorDetails?.logs && (
        <>
          <button
            onClick={() => setShowLogs(!showLogs)}
            style={{
              background: 'none',
              border: 'none',
              color: '#0070f3',
              cursor: 'pointer',
              padding: '8px 0',
              fontSize: '14px',
              display: 'flex',
              alignItems: 'center',
              gap: '4px',
              marginTop: '12px'
            }}
          >
            {showLogs ? '‚ñº' : '‚ñ∂'} Âá¶ÁêÜ„É≠„Ç∞„Çí{showLogs ? 'Èö†„Åô' : 'Ë°®Á§∫'}
          </button>

          {showLogs && (
            <div style={{
              backgroundColor: '#fff',
              border: '1px solid #e5e5e5',
              borderRadius: '4px',
              padding: '12px',
              marginTop: '8px',
              fontSize: '13px',
              fontFamily: 'monospace'
            }}>
              {errorDetails.logs.summary && (
                <div style={{ marginBottom: '12px' }}>
                  <strong>ÁîüÊàê„Çµ„Éû„É™„Éº:</strong>
                  <pre style={{ 
                    margin: '4px 0', 
                    whiteSpace: 'pre-wrap', 
                    wordBreak: 'break-word',
                    backgroundColor: '#f5f5f5',
                    padding: '8px',
                    borderRadius: '4px'
                  }}>
                    {JSON.stringify(errorDetails.logs.summary, null, 2)}
                  </pre>
                </div>
              )}

              {errorDetails.logs.errors && errorDetails.logs.errors.length > 0 && (
                <div style={{ marginBottom: '12px' }}>
                  <strong>„Ç®„É©„Éº„É≠„Ç∞:</strong>
                  <ul style={{ margin: '4px 0', paddingLeft: '20px' }}>
                    {errorDetails.logs.errors.map((err: any, idx: number) => (
                      <li key={idx} style={{ color: '#991b1b' }}>{err}</li>
                    ))}
                  </ul>
                </div>
              )}

              {errorDetails.logs.entries && errorDetails.logs.entries.length > 0 && (
                <div>
                  <strong>Âá¶ÁêÜ„É≠„Ç∞:</strong>
                  <div style={{ 
                    maxHeight: '150px', 
                    overflow: 'auto',
                    backgroundColor: '#f5f5f5',
                    padding: '8px',
                    borderRadius: '4px',
                    marginTop: '4px'
                  }}>
                    {errorDetails.logs.entries.map((entry: any, idx: number) => (
                      <div key={idx} style={{ fontSize: '12px', marginBottom: '2px' }}>
                        <span style={{ color: '#6b7280' }}>[{entry.timestamp || idx}]</span> {entry.message || entry}
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}
        </>
      )}

      {/* „É≠„Ç∞„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éú„Çø„É≥ */}
      {sessionId && onDownloadLogs && (
        <div style={{ 
          display: 'flex', 
          gap: '8px', 
          marginTop: '16px',
          paddingTop: '16px',
          borderTop: '1px solid #e5e5e5'
        }}>
          <button
            onClick={() => onDownloadLogs('json')}
            className={styles.button}
            style={{
              backgroundColor: '#0070f3',
              color: 'white',
              padding: '8px 16px',
              borderRadius: '4px',
              border: 'none',
              cursor: 'pointer',
              fontSize: '14px'
            }}
          >
            üì• JSON„É≠„Ç∞„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
          </button>
          <button
            onClick={() => onDownloadLogs('text')}
            className={styles.button}
            style={{
              backgroundColor: '#059669',
              color: 'white',
              padding: '8px 16px',
              borderRadius: '4px',
              border: 'none',
              cursor: 'pointer',
              fontSize: '14px'
            }}
          >
            üìÑ „ÉÜ„Ç≠„Çπ„Éà„É≠„Ç∞„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
          </button>
        </div>
      )}
    </div>
  )
}

export default ErrorDisplay