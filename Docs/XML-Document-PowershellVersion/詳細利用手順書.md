# PowerShell版 Windows 11 Sysprep応答ファイル生成システム 詳細利用手順書

## 目次
1. [はじめに](#はじめに)
2. [事前準備](#事前準備)
3. [基本的な使用方法](#基本的な使用方法)
4. [プリセットモードの詳細](#プリセットモードの詳細)
5. [インタラクティブモードの詳細](#インタラクティブモードの詳細)
6. [カスタム設定の作成と使用](#カスタム設定の作成と使用)
7. [バッチ処理での活用](#バッチ処理での活用)
8. [実践的な使用例](#実践的な使用例)
9. [生成されたXMLの確認と検証](#生成されたxmlの確認と検証)
10. [本番環境での適用](#本番環境での適用)

---

## はじめに

本書は、PowerShell版Windows 11 Sysprep応答ファイル生成システムの詳細な利用手順を説明します。企業のIT管理者やシステムエンジニアが、効率的にWindows 11のキッティング作業を行うための完全ガイドです。

### 対象読者
- 企業のIT管理者
- システムエンジニア
- PCキッティング担当者
- Windows展開担当者

### 前提知識
- PowerShellの基本的な操作
- Windows 11の基本的な管理知識
- Sysprepの概念理解

---

## 事前準備

### 1. システム要件の確認

```powershell
# PowerShellバージョンの確認
$PSVersionTable.PSVersion

# 必要バージョン: 5.0以上
# 推奨バージョン: 5.1
```

### 2. 実行ポリシーの設定

```powershell
# 現在の実行ポリシーを確認
Get-ExecutionPolicy

# RemoteSignedに設定（管理者権限で実行）
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser

# 確認プロンプトで「Y」を入力
```

### 3. 作業ディレクトリへの移動

```powershell
# PowerShellディレクトリに移動
cd E:\Generate-autounattendxml-files-for-Windows11\PowerShell

# ファイル構成を確認
Get-ChildItem -Recurse -Directory
```

### 4. モジュールのインポート確認

```powershell
# メインモジュールのインポート
Import-Module .\Generate-UnattendXML.psm1 -Force

# インポートされたコマンドの確認
Get-Command -Module Generate-UnattendXML
```

---

## 基本的な使用方法

### 方法1: シンプルな実行（デフォルト設定）

```powershell
# 最も簡単な実行方法
.\Generate-UnattendXML.ps1

# デフォルトでは以下が実行されます：
# - Enterpriseプリセットを使用
# - Outputs\unattend.xmlに保存
# - 基本的なログ出力
```

### 方法2: プリセット指定での実行

```powershell
# Enterpriseプリセットを明示的に指定
.\Generate-UnattendXML.ps1 -PresetName Enterprise -OutputPath ".\Outputs\enterprise.xml"

# Developmentプリセットを使用
.\Generate-UnattendXML.ps1 -PresetName Development -OutputPath ".\Outputs\development.xml"

# Minimalプリセットを使用
.\Generate-UnattendXML.ps1 -PresetName Minimal -OutputPath ".\Outputs\minimal.xml"
```

### 方法3: 詳細なログ付き実行

```powershell
# デバッグレベルのログを出力
.\Generate-UnattendXML.ps1 -PresetName Enterprise -LogLevel Debug

# ログファイルの確認
Get-Content ".\Logs\$(Get-Date -Format 'yyyy-MM-dd').log" -Tail 50
```

---

## プリセットモードの詳細

### Enterprise プリセット

#### 概要
企業環境向けの包括的な設定。セキュリティと管理性を重視。

#### 実行コマンド
```powershell
.\Generate-UnattendXML.ps1 -PresetName Enterprise `
    -OutputPath ".\Outputs\enterprise_$(Get-Date -Format 'yyyyMMdd').xml" `
    -LogLevel Information
```

#### 設定内容
| カテゴリ | 設定項目 | 設定値 |
|---------|----------|--------|
| **ユーザー** | mirai-user | 管理者グループ |
| | l-admin | 管理者グループ |
| | Administrator | 無効化 |
| **ネットワーク** | IPv6 | 無効 |
| | Windows Firewall | 全プロファイル無効 |
| | Bluetooth | 無効 |
| **Windows機能** | .NET Framework 3.5 | 有効 |
| | Windows Media Player | 無効 |
| | PowerShell ISE | 有効 |
| **アプリケーション** | 既定のブラウザ | Microsoft Edge |
| | 既定のメール | Outlook |
| | 既定のPDF | Adobe Acrobat Reader DC |

#### 使用例
```powershell
# 本番用設定の生成
$params = @{
    PresetName = "Enterprise"
    OutputPath = "D:\Deployment\unattend_production.xml"
    LogLevel = "Information"
    Validate = $true
}
.\Generate-UnattendXML.ps1 @params

# 生成結果の確認
if (Test-Path $params.OutputPath) {
    Write-Host "XMLファイルが正常に生成されました" -ForegroundColor Green
    # XMLの内容を確認
    [xml]$xml = Get-Content $params.OutputPath
    $xml.unattend.settings | Format-Table pass
}
```

### Development プリセット

#### 概要
開発者向けの環境。開発ツールと生産性向上機能を重視。

#### 実行コマンド
```powershell
.\Generate-UnattendXML.ps1 -PresetName Development `
    -OutputPath ".\Outputs\dev_environment.xml"
```

#### 特徴的な設定
- **Hyper-V**: 有効（仮想マシン開発用）
- **WSL2**: 有効（Linux環境統合）
- **Windows Sandbox**: 有効（テスト環境）
- **開発者モード**: 有効
- **リモートデスクトップ**: 有効

### Minimal プリセット

#### 概要
最小構成。リソース制約のある環境や特定用途向け。

#### 実行コマンド
```powershell
.\Generate-UnattendXML.ps1 -PresetName Minimal `
    -OutputPath ".\Outputs\minimal_config.xml"
```

#### 特徴
- 最小限のユーザーアカウント（1つ）
- 不要な機能の無効化
- 軽量な設定

---

## インタラクティブモードの詳細

### 起動方法

```powershell
# インタラクティブモードの起動
.\Generate-UnattendXML.ps1 -Interactive
```

### 対話フロー

#### ステップ1: 基本設定
```
===============================================
Windows 11 Sysprep応答ファイル生成ウィザード
===============================================

[1/7] コンピューター名を入力してください
> WIN11-PC001

[2/7] タイムゾーンを選択してください
1. Tokyo Standard Time (推奨)
2. China Standard Time
3. Pacific Standard Time
選択 > 1
```

#### ステップ2: ユーザーアカウント設定
```
[3/7] ユーザーアカウントの設定

作成するユーザー数を入力してください (1-10): 2

ユーザー 1:
  ユーザー名: mirai-user
  表示名: Mirai User
  パスワード: ********
  グループ (Administrators/Users): Administrators

ユーザー 2:
  ユーザー名: l-admin
  表示名: Local Admin
  パスワード: ********
  グループ: Administrators

Administratorアカウントを無効化しますか？ (Y/N): Y
```

#### ステップ3: ネットワーク設定
```
[4/7] ネットワーク設定

IPv6を無効化しますか？ (Y/N): Y
Windows Firewallを無効化しますか？ (Y/N): Y
Bluetoothを無効化しますか？ (Y/N): Y
```

#### ステップ4: Windows機能
```
[5/7] Windows機能の設定

.NET Framework 3.5を有効化しますか？ (Y/N): Y
Hyper-Vを有効化しますか？ (Y/N): N
WSLを有効化しますか？ (Y/N): N
```

#### ステップ5: アプリケーション設定
```
[6/7] アプリケーション設定

既定のブラウザ:
1. Microsoft Edge
2. Google Chrome
3. Mozilla Firefox
選択 > 1

既定のメールクライアント:
1. Outlook
2. Thunderbird
3. なし
選択 > 1
```

#### ステップ6: 確認と生成
```
[7/7] 設定の確認

以下の設定でXMLを生成します：
- コンピューター名: WIN11-PC001
- ユーザー数: 2
- ネットワーク: IPv6無効, Firewall無効
- Windows機能: .NET 3.5有効

続行しますか？ (Y/N): Y

XMLファイルを生成しています...
完了しました: .\Outputs\interactive_20240823.xml
```

---

## カスタム設定の作成と使用

### PowerShellハッシュテーブルでの設定作成

```powershell
# カスタム設定の定義
$customConfig = @{
    # システム設定
    System = @{
        ComputerName = "CUSTOM-PC"
        TimeZone = "Tokyo Standard Time"
        UILanguage = "ja-JP"
    }
    
    # ユーザー設定
    Users = @(
        @{
            Name = "admin-user"
            DisplayName = "管理者"
            Password = ConvertTo-SecureString "P@ssw0rd123!" -AsPlainText -Force
            Groups = @("Administrators")
            PasswordNeverExpires = $true
        },
        @{
            Name = "standard-user"
            DisplayName = "標準ユーザー"
            Password = ConvertTo-SecureString "User123!" -AsPlainText -Force
            Groups = @("Users")
        }
    )
    
    # ネットワーク設定
    Network = @{
        DisableIPv6 = $true
        DisableFirewall = $false  # Firewallは有効のまま
        DisableBluetooth = $true
        EnableUnsafeGuestLogons = $true
        DNSServers = @("8.8.8.8", "8.8.4.4")
    }
    
    # Windows機能
    WindowsFeatures = @{
        Enable = @(
            "NetFx3",
            "TelnetClient",
            "TFTP"
        )
        Disable = @(
            "WindowsMediaPlayer",
            "WorkFolders-Client"
        )
    }
    
    # アプリケーション設定
    Applications = @{
        DefaultBrowser = "MicrosoftEdge"
        DefaultEmail = "Outlook"
        DefaultPDF = "AdobeAcrobatReaderDC"
        RemoveApps = @(
            "Microsoft.Xbox*",
            "Microsoft.Gaming*"
        )
    }
}

# 設定をファイルに保存
$customConfig | Export-Clixml -Path ".\Configs\custom_config.xml"

# JSON形式で保存（人間が読みやすい）
$customConfig | ConvertTo-Json -Depth 5 | Out-File ".\Configs\custom_config.json"
```

### カスタム設定ファイルの使用

```powershell
# XML形式の設定ファイルを使用
.\Generate-UnattendXML.ps1 -ConfigFile ".\Configs\custom_config.xml"

# JSON形式の設定ファイルを使用
$config = Get-Content ".\Configs\custom_config.json" | ConvertFrom-Json
.\Generate-UnattendXML.ps1 -ConfigObject $config
```

### PSD1形式での設定ファイル作成

```powershell
# custom.psd1ファイルの作成
@'
@{
    System = @{
        ComputerName = 'DEPT-PC-001'
        TimeZone = 'Tokyo Standard Time'
    }
    
    Users = @(
        @{
            Name = 'dept-admin'
            Password = 'SecureP@ss2024!'
            Groups = @('Administrators')
        }
    )
    
    Network = @{
        DisableIPv6 = $true
        DisableFirewall = $true
    }
}
'@ | Out-File ".\Configs\department.psd1"

# PSD1ファイルの使用
.\Generate-UnattendXML.ps1 -ConfigFile ".\Configs\department.psd1"
```

---

## バッチ処理での活用

### 複数プリセットの一括生成

```powershell
# すべてのプリセットを一度に生成
@("Enterprise", "Development", "Minimal") | ForEach-Object {
    $preset = $_
    $outputFile = ".\Outputs\$($preset)_$(Get-Date -Format 'yyyyMMdd_HHmmss').xml"
    
    Write-Host "生成中: $preset プリセット" -ForegroundColor Cyan
    
    .\Generate-UnattendXML.ps1 `
        -PresetName $preset `
        -OutputPath $outputFile `
        -LogLevel Information
    
    if (Test-Path $outputFile) {
        Write-Host "✓ 完了: $outputFile" -ForegroundColor Green
    } else {
        Write-Host "✗ 失敗: $preset" -ForegroundColor Red
    }
}
```

### 部門別設定の一括生成

```powershell
# 部門情報の定義
$departments = @(
    @{Name="営業部"; Prefix="SALES"; Users=3},
    @{Name="開発部"; Prefix="DEV"; Users=5},
    @{Name="総務部"; Prefix="ADMIN"; Users=2}
)

# 各部門用のXMLを生成
foreach ($dept in $departments) {
    Write-Host "処理中: $($dept.Name)" -ForegroundColor Yellow
    
    # 部門別カスタム設定を作成
    $config = @{
        System = @{
            ComputerName = "$($dept.Prefix)-PC"
        }
        Users = @()
    }
    
    # ユーザーアカウントを生成
    for ($i = 1; $i -le $dept.Users; $i++) {
        $config.Users += @{
            Name = "$($dept.Prefix.ToLower())-user$i"
            Password = "P@ssw0rd$i!"
            Groups = if ($i -eq 1) { @("Administrators") } else { @("Users") }
        }
    }
    
    # XMLを生成
    $outputPath = ".\Outputs\$($dept.Prefix)_unattend.xml"
    
    # カスタム設定でスクリプトを実行
    .\Generate-UnattendXML.ps1 -ConfigObject $config -OutputPath $outputPath
    
    Write-Host "✓ 完了: $outputPath" -ForegroundColor Green
}
```

### CSV ファイルからの一括生成

```powershell
# computers.csv の例:
# ComputerName,Department,UserCount,DisableIPv6,DisableFirewall
# PC001,Sales,2,Yes,Yes
# PC002,Dev,3,No,Yes

# CSVファイルの読み込みと処理
$computers = Import-Csv ".\Configs\computers.csv"

foreach ($computer in $computers) {
    $config = @{
        System = @{
            ComputerName = $computer.ComputerName
        }
        Users = @()
        Network = @{
            DisableIPv6 = ($computer.DisableIPv6 -eq "Yes")
            DisableFirewall = ($computer.DisableFirewall -eq "Yes")
        }
    }
    
    # ユーザー作成
    for ($i = 1; $i -le [int]$computer.UserCount; $i++) {
        $config.Users += @{
            Name = "$($computer.Department)-user$i"
            Password = "TempP@ss$i!"
            Groups = if ($i -eq 1) { @("Administrators") } else { @("Users") }
        }
    }
    
    $outputPath = ".\Outputs\$($computer.ComputerName)_unattend.xml"
    .\Generate-UnattendXML.ps1 -ConfigObject $config -OutputPath $outputPath
    
    Write-Host "生成完了: $($computer.ComputerName)" -ForegroundColor Green
}
```

---

## 実践的な使用例

### 例1: 新規PC展開プロジェクト

#### シナリオ
50台の新規PCを3つの部門に展開する。

#### 実装手順

```powershell
# 1. プロジェクトディレクトリの作成
$projectDir = ".\Projects\2024Q1_Deployment"
New-Item -ItemType Directory -Force -Path $projectDir

# 2. 部門別設定の定義
$deploymentPlan = @{
    営業部 = @{
        PCCount = 20
        Prefix = "SALES"
        AdminUsers = 1
        StandardUsers = 1
        Features = @("Minimal")
    }
    開発部 = @{
        PCCount = 20
        Prefix = "DEV"
        AdminUsers = 2
        StandardUsers = 3
        Features = @("Development")
    }
    管理部 = @{
        PCCount = 10
        Prefix = "MGMT"
        AdminUsers = 1
        StandardUsers = 1
        Features = @("Enterprise")
    }
}

# 3. XML生成スクリプト
foreach ($dept in $deploymentPlan.Keys) {
    $settings = $deploymentPlan[$dept]
    
    for ($pc = 1; $pc -le $settings.PCCount; $pc++) {
        $computerName = "$($settings.Prefix)-PC$('{0:D3}' -f $pc)"
        
        Write-Host "生成中: $computerName ($dept)" -ForegroundColor Cyan
        
        .\Generate-UnattendXML.ps1 `
            -PresetName $settings.Features[0] `
            -OutputPath "$projectDir\$computerName.xml" `
            -ComputerNameOverride $computerName
    }
}

# 4. 生成結果の確認
Get-ChildItem $projectDir -Filter "*.xml" | 
    Group-Object { $_.Name.Substring(0,4) } | 
    Select-Object Name, Count
```

### 例2: 既存環境の更新

#### シナリオ
既存のWindows 11環境の設定を標準化する。

```powershell
# 1. 現在の設定をエクスポート
$currentSettings = @{
    ComputerInfo = Get-ComputerInfo
    LocalUsers = Get-LocalUser
    Features = Get-WindowsOptionalFeature -Online
}

# 2. 標準設定との差分を確認
$standardConfig = Import-Clixml ".\Configs\Presets\Enterprise.xml"

# 3. 更新用XMLを生成
.\Generate-UnattendXML.ps1 `
    -PresetName Enterprise `
    -OutputPath ".\Outputs\update_config.xml" `
    -UpdateMode  # 既存環境更新モード
```

### 例3: テスト環境の構築

```powershell
# テスト環境用の軽量設定
$testConfig = @{
    System = @{
        ComputerName = "TEST-VM"
        AutoLogon = $true
        AutoLogonCount = 999
    }
    Users = @(
        @{
            Name = "testadmin"
            Password = "Test123!"
            Groups = @("Administrators")
            AutoLogon = $true
        }
    )
    Network = @{
        DisableFirewall = $true  # テスト環境のため
    }
    TestMode = $true  # テストモード有効
}

# XML生成
.\Generate-UnattendXML.ps1 `
    -ConfigObject $testConfig `
    -OutputPath ".\Outputs\test_environment.xml" `
    -SkipValidation  # テスト用のため検証スキップ
```

---

## 生成されたXMLの確認と検証

### XMLファイルの検証

```powershell
# 基本的な検証
.\Generate-UnattendXML.ps1 -ValidateOnly -OutputPath ".\Outputs\enterprise.xml"

# 詳細な検証とレポート
$validationResult = .\Generate-UnattendXML.ps1 `
    -ValidateOnly `
    -OutputPath ".\Outputs\enterprise.xml" `
    -DetailedValidation

# 検証結果の表示
if ($validationResult.IsValid) {
    Write-Host "✓ XMLは有効です" -ForegroundColor Green
    $validationResult.Details | Format-Table
} else {
    Write-Host "✗ XMLにエラーがあります" -ForegroundColor Red
    $validationResult.Errors | ForEach-Object {
        Write-Host "  - $_" -ForegroundColor Yellow
    }
}
```

### XML内容の確認

```powershell
# XML構造の表示
[xml]$xml = Get-Content ".\Outputs\enterprise.xml"

# 設定パスの確認
$xml.unattend.settings | Select-Object pass | Format-Table

# ユーザーアカウントの確認
$xml.SelectNodes("//LocalAccount") | ForEach-Object {
    [PSCustomObject]@{
        Name = $_.Name
        Group = $_.Group
        Description = $_.Description
    }
} | Format-Table

# ネットワーク設定の確認
$xml.SelectNodes("//FirstLogonCommands/SynchronousCommand") | 
    Where-Object { $_.Description -like "*network*" -or $_.Description -like "*IPv6*" } |
    Select-Object Order, Description, CommandLine |
    Format-Table -Wrap
```

---

## 本番環境での適用

### 適用前のチェックリスト

```powershell
# チェックリストスクリプト
$checkList = @{
    "XMLファイルの存在確認" = { Test-Path ".\Outputs\production.xml" }
    "XML検証の実行" = { 
        $result = .\Generate-UnattendXML.ps1 -ValidateOnly -OutputPath ".\Outputs\production.xml"
        $result.IsValid
    }
    "バックアップの作成" = { 
        Copy-Item ".\Outputs\production.xml" ".\Backups\production_$(Get-Date -Format 'yyyyMMdd').xml"
        Test-Path ".\Backups\production_$(Get-Date -Format 'yyyyMMdd').xml"
    }
    "ログディレクトリの準備" = { 
        New-Item -ItemType Directory -Force -Path ".\Logs\Production"
        Test-Path ".\Logs\Production"
    }
}

# チェック実行
$results = @()
foreach ($check in $checkList.Keys) {
    $result = & $checkList[$check]
    $results += [PSCustomObject]@{
        項目 = $check
        結果 = if ($result) { "✓ OK" } else { "✗ NG" }
    }
}

$results | Format-Table -AutoSize
```

### Sysprepの実行

```powershell
# 1. XMLファイルをシステムドライブにコピー
Copy-Item ".\Outputs\production.xml" "C:\Windows\System32\Sysprep\unattend.xml"

# 2. Sysprepの実行（管理者権限必須）
# 注意: このコマンドを実行するとシステムが初期化されます
Start-Process -FilePath "C:\Windows\System32\Sysprep\sysprep.exe" `
    -ArgumentList "/generalize", "/oobe", "/shutdown", "/unattend:C:\Windows\System32\Sysprep\unattend.xml" `
    -Wait `
    -NoNewWindow

# 3. 結果の確認（Sysprepログ）
Get-Content "C:\Windows\System32\Sysprep\Panther\setupact.log" -Tail 50
```

### 展開後の確認

```powershell
# 展開後の設定確認スクリプト
$verificationScript = {
    # ユーザーアカウントの確認
    Write-Host "ユーザーアカウント:" -ForegroundColor Cyan
    Get-LocalUser | Format-Table Name, Enabled, Description
    
    # ネットワーク設定の確認
    Write-Host "`nネットワーク設定:" -ForegroundColor Cyan
    Get-NetAdapterBinding | Where-Object { $_.ComponentID -eq "ms_tcpip6" } | 
        Select-Object Name, Enabled
    
    # Windows機能の確認
    Write-Host "`nWindows機能:" -ForegroundColor Cyan
    Get-WindowsOptionalFeature -Online | 
        Where-Object { $_.FeatureName -like "*NetFx3*" } |
        Select-Object FeatureName, State
    
    # サービスの確認
    Write-Host "`nサービス状態:" -ForegroundColor Cyan
    @("Bluetooth*", "mpssvc") | ForEach-Object {
        Get-Service -Name $_ -ErrorAction SilentlyContinue
    } | Format-Table Name, Status, StartType
}

# 確認スクリプトの実行
& $verificationScript
```

---

## トラブルシューティング

### よくある問題と解決方法

#### 問題1: 実行ポリシーエラー
```powershell
# エラー: スクリプトの実行がブロックされる
# 解決方法:
Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process -Force
```

#### 問題2: モジュールのインポートエラー
```powershell
# エラー: モジュールが見つからない
# 解決方法:
$env:PSModulePath += ";$PWD\Modules"
Import-Module .\Generate-UnattendXML.psm1 -Force -Verbose
```

#### 問題3: XML生成エラー
```powershell
# エラーログの確認
Get-Content ".\Logs\$(Get-Date -Format 'yyyy-MM-dd').log" | 
    Select-String "ERROR" -Context 2,2
```

---

## まとめ

本手順書では、PowerShell版Windows 11 Sysprep応答ファイル生成システムの詳細な使用方法を説明しました。基本的な使用方法から高度なカスタマイズ、バッチ処理、本番環境での適用まで、実践的な内容を網羅しています。

### 重要なポイント
1. 事前準備をしっかり行う
2. プリセットを活用して効率化
3. カスタム設定で柔軟に対応
4. 検証を必ず実施
5. 本番適用前にバックアップ

### 次のステップ
- トラブルシューティングガイドの参照
- ベストプラクティスガイドの確認
- 設定リファレンスでの詳細確認

---

*最終更新日: 2024年8月23日*
*バージョン: 1.0.0*