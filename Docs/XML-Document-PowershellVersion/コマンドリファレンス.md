# Windows 11 Sysprep応答ファイル自動生成システム（PowerShell版）
## コマンドリファレンス

### 目次
1. [メインコマンド](#メインコマンド)
2. [モジュール関数](#モジュール関数)
3. [ヘルパー関数](#ヘルパー関数)
4. [診断・管理コマンド](#診断・管理コマンド)
5. [パラメーター詳細説明](#パラメーター詳細説明)
6. [戻り値とエラー処理](#戻り値とエラー処理)
7. [使用例集](#使用例集)

---

## メインコマンド

### Generate-UnattendXML.ps1

Windows 11 Sysprep用unattend.xmlファイルを生成するメインスクリプト。

#### 構文

```powershell
.\Generate-UnattendXML.ps1 
    [-PresetName <String>] 
    [-ConfigFile <String>] 
    [-OutputPath <String>] 
    [-Interactive] 
    [-ValidateOnly] 
    [-LogLevel <String>] 
    [-Force] 
    [-WhatIf]
```

#### パラメーター

| パラメーター | 必須 | 型 | 説明 | デフォルト |
|-------------|------|-----|------|-----------|
| `-PresetName` | ○* | String | 使用するプリセット名 | - |
| `-ConfigFile` | ○* | String | 設定ファイルのパス | - |
| `-Interactive` | ○* | Switch | 対話的ウィザードモード | - |
| `-ValidateOnly` | ○* | Switch | XML検証のみ実行 | - |
| `-OutputPath` | × | String | 出力先パス | 自動生成 |
| `-LogLevel` | × | String | ログレベル | "Info" |
| `-Force` | × | Switch | 既存ファイル強制上書き | False |
| `-WhatIf` | × | Switch | 処理内容確認のみ | False |

*印の付いたパラメーターは、いずれか一つが必須

#### パラメーターセット

##### PresetSet
```powershell
.\Generate-UnattendXML.ps1 -PresetName <String> [-OutputPath <String>] [-LogLevel <String>] [-Force] [-WhatIf]
```

##### ConfigFileSet
```powershell
.\Generate-UnattendXML.ps1 -ConfigFile <String> [-OutputPath <String>] [-LogLevel <String>] [-Force] [-WhatIf]
```

##### InteractiveSet
```powershell
.\Generate-UnattendXML.ps1 -Interactive [-LogLevel <String>]
```

##### ValidateOnlySet
```powershell
.\Generate-UnattendXML.ps1 -ValidateOnly [-OutputPath <String>] [-LogLevel <String>]
```

#### 使用例

##### 基本的な使用
```powershell
# Enterpriseプリセットで生成
.\Generate-UnattendXML.ps1 -PresetName Enterprise

# 出力先指定
.\Generate-UnattendXML.ps1 -PresetName Development -OutputPath "C:\Deploy\unattend.xml"

# カスタム設定ファイル使用
.\Generate-UnattendXML.ps1 -ConfigFile ".\MyConfig.psd1" -OutputPath ".\custom.xml"
```

##### 高度な使用
```powershell
# デバッグモードで実行
.\Generate-UnattendXML.ps1 -PresetName Enterprise -LogLevel Debug -Force

# 処理内容確認のみ
.\Generate-UnattendXML.ps1 -PresetName Development -WhatIf

# 対話的ウィザード
.\Generate-UnattendXML.ps1 -Interactive

# XML検証のみ
.\Generate-UnattendXML.ps1 -ValidateOnly -OutputPath ".\existing_unattend.xml"
```

#### 戻り値

| 条件 | 戻り値 | 説明 |
|------|--------|------|
| 正常終了 | 0 | XML生成成功 |
| 一般エラー | 1 | 設定エラー、ファイルI/Oエラーなど |
| 検証エラー | 1 | XML検証失敗（ValidateOnlyモード） |

---

## モジュール関数

### Generate-UnattendXML.psm1

メインモジュールで提供される関数群。

#### New-UnattendXML

UnattendXMLファイルを生成する中核関数。

##### 構文
```powershell
New-UnattendXML 
    [-Config <UnattendGeneratorConfig>] 
    [-PresetName <String>] 
    [-OutputPath <String>]
```

##### パラメーター
| パラメーター | 必須 | 型 | 説明 |
|-------------|------|-----|------|
| `-Config` | ○* | UnattendGeneratorConfig | 設定オブジェクト |
| `-PresetName` | ○* | String | プリセット名 |
| `-OutputPath` | × | String | 出力先パス |

*いずれか一つが必須

##### 使用例
```powershell
# プリセット指定
$result = New-UnattendXML -PresetName "Enterprise" -OutputPath "C:\Deploy\unattend.xml"

# 設定オブジェクト指定
$config = Import-UnattendPreset -PresetName "Development"
$result = New-UnattendXML -Config $config -OutputPath ".\dev-unattend.xml"
```

---

#### Start-UnattendXMLWizard

対話的なウィザードを開始する関数。

##### 構文
```powershell
Start-UnattendXMLWizard
```

##### パラメーター
なし

##### 使用例
```powershell
# ウィザード開始
Start-UnattendXMLWizard
```

##### ウィザードフロー
1. プリセット選択画面
2. カスタム設定入力（Custom選択時）
3. 出力先指定
4. XML生成実行
5. 結果表示

---

#### Import-UnattendPreset

プリセット設定ファイルを読み込む関数。

##### 構文
```powershell
Import-UnattendPreset 
    -PresetName <String>
```

##### パラメーター
| パラメーター | 必須 | 型 | 説明 |
|-------------|------|-----|------|
| `-PresetName` | ○ | String | プリセット名 |

##### 有効なプリセット名
- `"Development"` - 開発環境用設定
- `"Enterprise"` - 企業環境用設定  
- `"Minimal"` - 最小構成設定
- `"Custom"` - カスタム設定（対話式入力）

##### 使用例
```powershell
# プリセット読み込み
$config = Import-UnattendPreset -PresetName "Enterprise"

# 設定内容の確認
Write-Host "ホスト名: $($config.System.HostName)"
Write-Host "ユーザー数: $($config.Users.Count)"
```

##### 戻り値
`UnattendGeneratorConfig` オブジェクト

---

#### New-CustomUnattendConfig

カスタム設定を対話的に作成する関数。

##### 構文
```powershell
New-CustomUnattendConfig
```

##### パラメーター
なし

##### 使用例
```powershell
# カスタム設定作成
$customConfig = New-CustomUnattendConfig

# 作成した設定でXML生成
New-UnattendXML -Config $customConfig -OutputPath ".\custom.xml"
```

##### 対話的入力項目
- ホスト名
- IPv6無効化
- Firewall無効化  
- Bluetooth無効化
- デフォルトユーザー設定

---

### モジュールクラス

#### UnattendGeneratorConfig

UnattendXML生成の設定を管理するクラス。

##### プロパティ
| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `System` | UnattendSystemConfig | システム設定 |
| `Users` | UnattendUserConfig[] | ユーザー設定配列 |
| `Applications` | UnattendApplicationConfig | アプリケーション設定 |
| `CustomSettings` | Hashtable | カスタム設定 |

##### メソッド
| メソッド | 説明 |
|---------|------|
| `AddUser([UnattendUserConfig]$user)` | ユーザーを追加 |
| `SetupDefaultUsers()` | デフォルトユーザーを設定 |

##### 使用例
```powershell
# 新規設定オブジェクト作成
$config = [UnattendGeneratorConfig]::new()

# ホスト名設定
$config.System.HostName = "CUSTOM-PC-001"

# ユーザー追加
$password = ConvertTo-SecureString "CustomUser2025!" -AsPlainText -Force
$user = [UnattendUserConfig]::new("custom-user", $password, @("Users"))
$config.AddUser($user)

# デフォルトユーザー設定
$config.SetupDefaultUsers()
```

---

#### UnattendXMLGenerator

XML生成の中核を担うクラス。

##### コンストラクタ
```powershell
[UnattendXMLGenerator]::new([UnattendGeneratorConfig]$config)
```

##### メソッド
| メソッド | 戻り値 | 説明 |
|---------|--------|------|
| `GenerateUnattendXML()` | String | XMLファイル生成（パス返却） |
| `WriteLog([LogLevel]$level, [string]$message)` | Void | ログ出力 |
| `AddJob([string]$name, [scriptblock]$script, [hashtable]$parameters)` | Void | 並列ジョブ追加 |
| `WaitForAllJobs()` | Hashtable | 全ジョブ完了待ち |

##### 使用例
```powershell
# 設定読み込み
$config = Import-UnattendPreset -PresetName "Enterprise"

# ジェネレーター初期化
$generator = [UnattendXMLGenerator]::new($config)

# XML生成実行
$outputPath = $generator.GenerateUnattendXML()
Write-Host "生成完了: $outputPath"
```

---

## ヘルパー関数

### 設定ファイル関連

#### Test-UnattendXMLDocument

XMLファイルの妥当性検証を行う関数。

##### 構文
```powershell
Test-UnattendXMLDocument 
    -XmlPath <String>
```

##### パラメーター
| パラメーター | 必須 | 型 | 説明 |
|-------------|------|-----|------|
| `-XmlPath` | ○ | String | 検証するXMLファイルのパス |

##### 戻り値
検証結果オブジェクト
```powershell
@{
    IsValid = $true/$false
    ValidationErrors = @("エラー1", "エラー2", ...)
    ValidationWarnings = @("警告1", "警告2", ...)
}
```

##### 使用例
```powershell
# XML検証実行
$result = Test-UnattendXMLDocument -XmlPath ".\unattend.xml"

if ($result.IsValid) {
    Write-Host "検証成功" -ForegroundColor Green
} else {
    Write-Host "検証失敗" -ForegroundColor Red
    $result.ValidationErrors | ForEach-Object {
        Write-Host "エラー: $_" -ForegroundColor Red
    }
}
```

---

### ユーザー管理関連

#### New-UnattendUserConfiguration

ユーザー設定のXMLセクションを生成する関数。

##### 構文
```powershell
New-UnattendUserConfiguration 
    -Config <Object> 
    -XmlDocument <XmlDocument>
```

##### パラメーター
| パラメーター | 必須 | 型 | 説明 |
|-------------|------|-----|------|
| `-Config` | ○ | Object | ユーザー設定オブジェクト |
| `-XmlDocument` | ○ | XmlDocument | 対象XMLドキュメント |

##### 戻り値
XMLElementオブジェクト

---

### ネットワーク設定関連

#### New-UnattendNetworkConfiguration

ネットワーク設定のXMLセクションを生成する関数。

##### 構文
```powershell
New-UnattendNetworkConfiguration 
    -Config <Object> 
    -XmlDocument <XmlDocument>
```

##### パラメーター
| パラメーター | 必須 | 型 | 説明 |
|-------------|------|-----|------|
| `-Config` | ○ | Object | ネットワーク設定オブジェクト |
| `-XmlDocument` | ○ | XmlDocument | 対象XMLドキュメント |

##### 戻り値
XMLElementオブジェクト

---

### Windows機能関連

#### New-UnattendWindowsFeatures

Windows機能設定のXMLセクションを生成する関数。

##### 構文
```powershell
New-UnattendWindowsFeatures 
    -Config <Object> 
    -XmlDocument <XmlDocument>
```

##### パラメーター
| パラメーター | 必須 | 型 | 説明 |
|-------------|------|-----|------|
| `-Config` | ○ | Object | Windows機能設定オブジェクト |
| `-XmlDocument` | ○ | XmlDocument | 対象XMLドキュメント |

##### 戻り値
XMLElementオブジェクト

---

### アプリケーション設定関連

#### New-UnattendApplicationConfiguration

アプリケーション設定のXMLセクションを生成する関数。

##### 構文
```powershell
New-UnattendApplicationConfiguration 
    -Config <Object> 
    -XmlDocument <XmlDocument>
```

##### パラメーター
| パラメーター | 必須 | 型 | 説明 |
|-------------|------|-----|------|
| `-Config` | ○ | Object | アプリケーション設定オブジェクト |
| `-XmlDocument` | ○ | XmlDocument | 対象XMLドキュメント |

##### 戻り値
XMLElementオブジェクト

---

## 診断・管理コマンド

### システム診断

#### Test-SystemRequirements

システム要件を確認する診断関数。

##### 構文
```powershell
Test-SystemRequirements 
    [-Detailed]
```

##### パラメーター
| パラメーター | 必須 | 型 | 説明 |
|-------------|------|-----|------|
| `-Detailed` | × | Switch | 詳細情報を表示 |

##### 戻り値
診断結果オブジェクト

##### 使用例
```powershell
# 基本診断
$result = Test-SystemRequirements

# 詳細診断
$result = Test-SystemRequirements -Detailed

# 結果確認
if ($result.IsCompatible) {
    Write-Host "システム要件を満たしています" -ForegroundColor Green
} else {
    Write-Host "システム要件を満たしていません" -ForegroundColor Red
    $result.Issues | ForEach-Object { Write-Host "問題: $_" }
}
```

---

#### Test-ModuleIntegrity

モジュールファイルの整合性を確認する関数。

##### 構文
```powershell
Test-ModuleIntegrity 
    [-ModulePath <String>]
```

##### パラメーター
| パラメーター | 必須 | 型 | 説明 |
|-------------|------|-----|------|
| `-ModulePath` | × | String | モジュールのルートパス |

##### 戻り値
整合性チェック結果

##### 使用例
```powershell
# デフォルトパスでの整合性チェック
$integrity = Test-ModuleIntegrity

# 特定パスでの整合性チェック
$integrity = Test-ModuleIntegrity -ModulePath "C:\CustomPath\Modules"

# 結果表示
$integrity.MissingFiles | ForEach-Object {
    Write-Host "不足ファイル: $_" -ForegroundColor Red
}
```

---

### パフォーマンス診断

#### Measure-GenerationPerformance

XML生成パフォーマンスを測定する関数。

##### 構文
```powershell
Measure-GenerationPerformance 
    -PresetName <String> 
    [-Iterations <Int32>] 
    [-OutputReport]
```

##### パラメーター
| パラメーター | 必須 | 型 | 説明 |
|-------------|------|-----|------|
| `-PresetName` | ○ | String | 測定対象プリセット |
| `-Iterations` | × | Int32 | 測定反復回数 |
| `-OutputReport` | × | Switch | 詳細レポート出力 |

##### 戻り値
パフォーマンス測定結果

##### 使用例
```powershell
# 基本パフォーマンス測定
$perf = Measure-GenerationPerformance -PresetName "Enterprise"

# 詳細測定（10回反復）
$perf = Measure-GenerationPerformance -PresetName "Development" -Iterations 10 -OutputReport

# 結果表示
Write-Host "平均実行時間: $($perf.AverageTime)ms"
Write-Host "最小実行時間: $($perf.MinTime)ms"
Write-Host "最大実行時間: $($perf.MaxTime)ms"
```

---

### ログ管理

#### Get-UnattendXMLLog

ログファイルの内容を取得・解析する関数。

##### 構文
```powershell
Get-UnattendXMLLog 
    [-LogPath <String>] 
    [-Level <String>] 
    [-After <DateTime>] 
    [-Tail <Int32>]
```

##### パラメーター
| パラメーター | 必須 | 型 | 説明 |
|-------------|------|-----|------|
| `-LogPath` | × | String | ログファイルパス |
| `-Level` | × | String | フィルターするログレベル |
| `-After` | × | DateTime | 指定日時以降のログ |
| `-Tail` | × | Int32 | 最新N行を取得 |

##### 使用例
```powershell
# 最新ログファイルの内容を取得
$logs = Get-UnattendXMLLog

# エラーレベルのみフィルター
$errors = Get-UnattendXMLLog -Level "Error"

# 最新50行を取得
$recent = Get-UnattendXMLLog -Tail 50

# 特定日時以降のログ
$today = Get-Date -Hour 0 -Minute 0 -Second 0
$todayLogs = Get-UnattendXMLLog -After $today
```

---

#### Clear-UnattendXMLLog

ログファイルをクリーンアップする関数。

##### 構文
```powershell
Clear-UnattendXMLLog 
    [-OlderThanDays <Int32>] 
    [-KeepFiles <Int32>] 
    [-Force]
```

##### パラメーター
| パラメーター | 必須 | 型 | 説明 |
|-------------|------|-----|------|
| `-OlderThanDays` | × | Int32 | 指定日数以前のログを削除 |
| `-KeepFiles` | × | Int32 | 保持するファイル数 |
| `-Force` | × | Switch | 確認なしで実行 |

##### 使用例
```powershell
# 30日以前のログを削除
Clear-UnattendXMLLog -OlderThanDays 30

# 最新10ファイルのみ保持
Clear-UnattendXMLLog -KeepFiles 10 -Force

# 組み合わせ使用
Clear-UnattendXMLLog -OlderThanDays 7 -KeepFiles 5
```

---

## パラメーター詳細説明

### -PresetName

定義済みのプリセット設定を指定します。

#### 有効値
| 値 | 説明 | 対象環境 |
|----|------|----------|
| `Development` | 開発環境向け設定 | 開発者PC、テスト環境 |
| `Enterprise` | 企業環境向け設定 | 本番業務PC、セキュリティ重視 |
| `Minimal` | 最小構成設定 | 軽量環境、リソース制約 |
| `Custom` | カスタム設定 | 対話的設定入力 |

#### 使用例
```powershell
# 基本使用
.\Generate-UnattendXML.ps1 -PresetName "Enterprise"

# 大文字小文字混在も可能
.\Generate-UnattendXML.ps1 -PresetName "enterprise"
```

---

### -ConfigFile

外部設定ファイルのパスを指定します。

#### サポート形式
- **PSD1** (PowerShell Data File): 推奨形式
- **JSON**: 一部制限あり

#### パス指定方法
- 絶対パス: `C:\Path\To\Config.psd1`
- 相対パス: `.\Configs\MyConfig.psd1`
- UNCパス: `\\Server\Share\Config.psd1`

#### 使用例
```powershell
# PSD1ファイル
.\Generate-UnattendXML.ps1 -ConfigFile ".\Custom\MySettings.psd1"

# JSONファイル
.\Generate-UnattendXML.ps1 -ConfigFile "C:\Deploy\settings.json"

# ネットワークパス
.\Generate-UnattendXML.ps1 -ConfigFile "\\FileServer\Configs\enterprise.psd1"
```

---

### -OutputPath

生成されるXMLファイルの出力先を指定します。

#### パス形式
- 絶対パス推奨
- ディレクトリが存在しない場合は自動作成
- 拡張子は`.xml`を推奨

#### デフォルト動作
パラメーター省略時は以下の形式で自動生成：
```
.\Outputs\unattend_{HostName}_{Timestamp}.xml
```

#### 使用例
```powershell
# 基本指定
.\Generate-UnattendXML.ps1 -PresetName Enterprise -OutputPath "C:\Deploy\unattend.xml"

# ディレクトリ自動作成
.\Generate-UnattendXML.ps1 -PresetName Development -OutputPath "C:\NewFolder\dev.xml"

# タイムスタンプ付きファイル名
$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
.\Generate-UnattendXML.ps1 -PresetName Minimal -OutputPath ".\Outputs\minimal_$timestamp.xml"
```

---

### -LogLevel

ログ出力の詳細レベルを制御します。

#### レベル定義
| レベル | 数値 | 出力内容 | 用途 |
|--------|------|----------|------|
| `Debug` | 0 | 詳細なデバッグ情報 | 開発・トラブルシューティング |
| `Info` | 1 | 一般的な情報メッセージ | 通常運用 |
| `Warning` | 2 | 警告メッセージ | 問題の兆候確認 |
| `Error` | 3 | エラーメッセージ | エラー原因調査 |
| `Critical` | 4 | 致命的エラーのみ | 本番環境最小ログ |

#### 使用例
```powershell
# デバッグレベル（最詳細）
.\Generate-UnattendXML.ps1 -PresetName Development -LogLevel Debug

# 警告以上のみ表示
.\Generate-UnattendXML.ps1 -PresetName Enterprise -LogLevel Warning

# エラーのみ表示
.\Generate-UnattendXML.ps1 -PresetName Minimal -LogLevel Error
```

---

### -Force

既存ファイルの強制上書きを許可します。

#### 動作変更
- 通常: 既存ファイルがある場合は確認プロンプトまたはエラー
- Forceあり: 確認なしで上書き

#### 使用例
```powershell
# 既存ファイルを強制上書き
.\Generate-UnattendXML.ps1 -PresetName Enterprise -OutputPath ".\existing.xml" -Force

# バッチ処理での使用
$presets = @("Development", "Enterprise", "Minimal")
foreach ($preset in $presets) {
    .\Generate-UnattendXML.ps1 -PresetName $preset -OutputPath ".\$preset.xml" -Force
}
```

---

### -WhatIf

実際の処理を行わず、処理内容の確認のみ実行します。

#### 表示内容
- 使用される設定の概要
- 生成予定のファイルパス
- 主要な設定項目

#### 使用例
```powershell
# 処理内容の事前確認
.\Generate-UnattendXML.ps1 -PresetName Enterprise -WhatIf

# 出力例:
# WhatIfモード: 実際の生成は行わず、処理内容のみ表示
# === 生成予定の設定内容 ===
# ホスト名: WIN11-ENT
# ユーザー数: 4
# IPv6無効化: True
# Firewall無効化: True
# 出力先: .\Outputs\unattend_WIN11-ENT_20250122_143052.xml
# ==========================
```

---

### -Interactive

対話的なウィザードモードで実行します。

#### ウィザードの流れ
1. **プリセット選択**: 矢印キーで選択、Enterで確定
2. **カスタム設定**: Custom選択時のみ詳細設定入力
3. **出力先指定**: ファイルパス入力
4. **生成実行**: 設定内容確認後実行
5. **結果表示**: 生成されたファイル情報表示

#### 使用例
```powershell
# ウィザード開始
.\Generate-UnattendXML.ps1 -Interactive

# 他のパラメーターと組み合わせ不可
# ❌ 無効: .\Generate-UnattendXML.ps1 -Interactive -PresetName Enterprise
```

---

### -ValidateOnly

既存XMLファイルの検証のみを実行します。

#### 検証項目
- XML構文の妥当性
- unattendスキーマ準拠性
- 必須要素の存在確認
- セキュリティ上の問題確認

#### 戻り値
- **終了コード 0**: 検証成功
- **終了コード 1**: 検証失敗

#### 使用例
```powershell
# 特定ファイルの検証
.\Generate-UnattendXML.ps1 -ValidateOnly -OutputPath "C:\Deploy\unattend.xml"

# バッチスクリプトでの検証
$xmlFiles = Get-ChildItem "C:\Deploy\*.xml"
foreach ($file in $xmlFiles) {
    Write-Host "検証中: $($file.Name)"
    .\Generate-UnattendXML.ps1 -ValidateOnly -OutputPath $file.FullName
    if ($LASTEXITCODE -eq 0) {
        Write-Host "✅ 検証成功" -ForegroundColor Green
    } else {
        Write-Host "❌ 検証失敗" -ForegroundColor Red
    }
}
```

---

## 戻り値とエラー処理

### 終了コード

| コード | 意味 | 対応 |
|--------|------|------|
| 0 | 正常終了 | 処理成功 |
| 1 | 一般エラー | ログ確認・設定見直し |
| 2 | パラメーターエラー | 引数確認 |
| 3 | ファイルアクセスエラー | 権限・パス確認 |
| 4 | モジュールエラー | インストール確認 |

### エラーハンドリングパターン

#### 基本的なエラーハンドリング
```powershell
try {
    $result = .\Generate-UnattendXML.ps1 -PresetName Enterprise -OutputPath ".\output.xml"
    Write-Host "生成成功: $result" -ForegroundColor Green
}
catch {
    Write-Host "エラー発生: $($_.Exception.Message)" -ForegroundColor Red
    
    # 終了コードによる分岐
    switch ($LASTEXITCODE) {
        1 { Write-Host "一般エラー: 設定を確認してください" }
        2 { Write-Host "パラメーターエラー: 引数を確認してください" }
        3 { Write-Host "ファイルアクセスエラー: 権限を確認してください" }
        4 { Write-Host "モジュールエラー: インストールを確認してください" }
        default { Write-Host "不明なエラー: サポートに連絡してください" }
    }
}
```

#### 高度なエラーハンドリング
```powershell
function Invoke-UnattendGenerationWithRetry {
    param(
        [string]$PresetName,
        [string]$OutputPath,
        [int]$MaxRetries = 3
    )
    
    $attempt = 1
    
    do {
        try {
            Write-Host "実行試行 $attempt/$MaxRetries" -ForegroundColor Yellow
            
            $result = .\Generate-UnattendXML.ps1 -PresetName $PresetName -OutputPath $OutputPath -Force
            
            Write-Host "生成成功: $result" -ForegroundColor Green
            return $result
        }
        catch {
            Write-Host "試行 $attempt 失敗: $($_.Exception.Message)" -ForegroundColor Red
            
            if ($attempt -lt $MaxRetries) {
                Write-Host "3秒後に再試行します..." -ForegroundColor Yellow
                Start-Sleep -Seconds 3
            } else {
                Write-Host "最大試行回数に達しました。処理を中断します。" -ForegroundColor Red
                throw
            }
        }
        
        $attempt++
    } while ($attempt -le $MaxRetries)
}

# 使用例
Invoke-UnattendGenerationWithRetry -PresetName "Enterprise" -OutputPath ".\enterprise.xml"
```

---

## 使用例集

### 基本的な使用パターン

#### パターン1: プリセット使用
```powershell
# 最もシンプルな使用方法
.\Generate-UnattendXML.ps1 -PresetName Enterprise

# 出力先を指定
.\Generate-UnattendXML.ps1 -PresetName Development -OutputPath "C:\Deploy\dev.xml"

# デバッグ情報を表示
.\Generate-UnattendXML.ps1 -PresetName Minimal -LogLevel Debug
```

#### パターン2: 設定ファイル使用
```powershell
# PSD1設定ファイル
.\Generate-UnattendXML.ps1 -ConfigFile ".\MyConfig.psd1" -OutputPath ".\custom.xml"

# JSON設定ファイル
.\Generate-UnattendXML.ps1 -ConfigFile ".\settings.json" -Force
```

#### パターン3: 対話的使用
```powershell
# ウィザード形式で設定
.\Generate-UnattendXML.ps1 -Interactive

# XMLファイルの検証
.\Generate-UnattendXML.ps1 -ValidateOnly -OutputPath ".\existing.xml"
```

---

### 実践的な使用パターン

#### パターン1: 一括生成スクリプト
```powershell
# 複数プリセットの一括生成
$presets = @("Development", "Enterprise", "Minimal")
$timestamp = Get-Date -Format "yyyyMMdd"

foreach ($preset in $presets) {
    $outputFile = ".\Outputs\unattend_${preset}_${timestamp}.xml"
    
    try {
        Write-Host "生成中: $preset" -ForegroundColor Yellow
        .\Generate-UnattendXML.ps1 -PresetName $preset -OutputPath $outputFile -Force
        
        # 生成されたファイルのサイズ確認
        $fileSize = (Get-Item $outputFile).Length
        Write-Host "✅ 生成完了: $preset ($fileSize bytes)" -ForegroundColor Green
    }
    catch {
        Write-Host "❌ 生成失敗: $preset - $_" -ForegroundColor Red
    }
}
```

#### パターン2: 設定検証付き生成
```powershell
# 設定の事前確認と生成
function New-ValidatedUnattendXML {
    param(
        [string]$PresetName,
        [string]$OutputPath
    )
    
    # 事前確認（WhatIf）
    Write-Host "設定内容の確認..." -ForegroundColor Yellow
    .\Generate-UnattendXML.ps1 -PresetName $PresetName -WhatIf
    
    # ユーザー確認
    $confirm = Read-Host "この設定で生成しますか？ (y/N)"
    if ($confirm -ne "y" -and $confirm -ne "Y") {
        Write-Host "処理をキャンセルしました" -ForegroundColor Yellow
        return
    }
    
    # 実際の生成
    try {
        $result = .\Generate-UnattendXML.ps1 -PresetName $PresetName -OutputPath $OutputPath -Force
        
        # 生成後検証
        .\Generate-UnattendXML.ps1 -ValidateOnly -OutputPath $result
        
        if ($LASTEXITCODE -eq 0) {
            Write-Host "✅ 生成・検証完了: $result" -ForegroundColor Green
        } else {
            Write-Host "⚠️ 生成完了、検証で警告あり: $result" -ForegroundColor Yellow
        }
        
        return $result
    }
    catch {
        Write-Host "❌ 生成失敗: $_" -ForegroundColor Red
        throw
    }
}

# 使用例
New-ValidatedUnattendXML -PresetName "Enterprise" -OutputPath ".\verified_enterprise.xml"
```

#### パターン3: MDT統合スクリプト
```powershell
# MDT（Microsoft Deployment Toolkit）との統合
function Deploy-UnattendToMDT {
    param(
        [Parameter(Mandatory=$true)]
        [string]$MDTPath,
        
        [Parameter(Mandatory=$true)]
        [string]$PresetName,
        
        [switch]$Backup
    )
    
    $mdtUnattendPath = Join-Path $MDTPath "Control\unattend.xml"
    $backupPath = Join-Path $MDTPath "Control\unattend.xml.backup"
    
    try {
        # 既存ファイルのバックアップ
        if ($Backup -and (Test-Path $mdtUnattendPath)) {
            Copy-Item $mdtUnattendPath $backupPath -Force
            Write-Host "✅ 既存ファイルをバックアップしました" -ForegroundColor Green
        }
        
        # 新しいunattend.xml生成
        Write-Host "UnattendXML生成中..." -ForegroundColor Yellow
        $result = .\Generate-UnattendXML.ps1 -PresetName $PresetName -OutputPath $mdtUnattendPath -Force
        
        # MDT固有の検証
        if (Test-Path $result) {
            $xmlContent = Get-Content $result -Raw
            if ($xmlContent -match '<unattend.*xmlns="urn:schemas-microsoft-com:unattend"') {
                Write-Host "✅ MDT配置完了: $result" -ForegroundColor Green
                
                # 統計情報
                $fileSize = (Get-Item $result).Length
                $lineCount = (Get-Content $result).Count
                Write-Host "ファイルサイズ: $fileSize bytes" -ForegroundColor Gray
                Write-Host "行数: $lineCount" -ForegroundColor Gray
            } else {
                throw "生成されたXMLが正しい形式ではありません"
            }
        } else {
            throw "XMLファイルの生成に失敗しました"
        }
    }
    catch {
        Write-Host "❌ MDT配置エラー: $_" -ForegroundColor Red
        
        # バックアップからの復旧
        if ($Backup -and (Test-Path $backupPath)) {
            Copy-Item $backupPath $mdtUnattendPath -Force
            Write-Host "⚡ バックアップから復旧しました" -ForegroundColor Yellow
        }
        
        throw
    }
}

# 使用例
Deploy-UnattendToMDT -MDTPath "C:\DeploymentShare" -PresetName "Enterprise" -Backup
```

#### パターン4: スケジュール実行対応
```powershell
# タスクスケジューラ用のラッパースクリプト
# scheduled-unattend-generation.ps1

param(
    [string]$ConfigPath = ".\scheduled-config.psd1",
    [string]$OutputDir = "\\FileServer\Deploy\UnattendFiles",
    [string]$LogPath = ".\Logs\scheduled.log",
    [int]$RetentionDays = 30
)

# ログ関数
function Write-ScheduledLog {
    param([string]$Message)
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    "$timestamp - $Message" | Out-File $LogPath -Append -Encoding UTF8
}

try {
    Write-ScheduledLog "スケジュール実行開始"
    
    # 出力ディレクトリ確認
    if (!(Test-Path $OutputDir)) {
        New-Item -Path $OutputDir -ItemType Directory -Force | Out-Null
        Write-ScheduledLog "出力ディレクトリ作成: $OutputDir"
    }
    
    # XML生成
    $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
    $outputFile = Join-Path $OutputDir "scheduled_unattend_$timestamp.xml"
    
    $result = .\Generate-UnattendXML.ps1 -ConfigFile $ConfigPath -OutputPath $outputFile -Force
    Write-ScheduledLog "XML生成完了: $result"
    
    # 古いファイルの削除
    $cutoffDate = (Get-Date).AddDays(-$RetentionDays)
    $oldFiles = Get-ChildItem $OutputDir -Filter "scheduled_unattend_*.xml" | Where-Object CreationTime -lt $cutoffDate
    
    foreach ($file in $oldFiles) {
        Remove-Item $file.FullName -Force
        Write-ScheduledLog "古いファイル削除: $($file.Name)"
    }
    
    Write-ScheduledLog "スケジュール実行完了"
}
catch {
    Write-ScheduledLog "エラー発生: $_"
    exit 1
}
```

---

### デバッグ・トラブルシューティング用パターン

#### パターン1: 詳細ログ付き実行
```powershell
# 詳細ログでトラブルシューティング
function Debug-UnattendGeneration {
    param(
        [string]$PresetName,
        [string]$OutputPath
    )
    
    $debugLogPath = ".\Logs\debug_$(Get-Date -Format 'yyyyMMdd_HHmmss').log"
    
    try {
        Write-Host "デバッグモードで実行中..." -ForegroundColor Yellow
        Write-Host "デバッグログ: $debugLogPath" -ForegroundColor Gray
        
        # デバッグレベルで実行
        .\Generate-UnattendXML.ps1 -PresetName $PresetName -OutputPath $OutputPath -LogLevel Debug -Force
        
        # ログ解析
        Write-Host ""
        Write-Host "=== デバッグ情報サマリー ===" -ForegroundColor Cyan
        
        $logContent = Get-Content (Get-ChildItem ".\Logs\*.log" | Sort-Object LastWriteTime -Descending | Select-Object -First 1).FullName
        
        $errors = $logContent | Where-Object { $_ -match "\[Error\]" }
        $warnings = $logContent | Where-Object { $_ -match "\[Warning\]" }
        $debugs = $logContent | Where-Object { $_ -match "\[Debug\]" }
        
        Write-Host "エラー数: $($errors.Count)" -ForegroundColor Red
        Write-Host "警告数: $($warnings.Count)" -ForegroundColor Yellow
        Write-Host "デバッグメッセージ数: $($debugs.Count)" -ForegroundColor Gray
        
        # エラーの詳細表示
        if ($errors.Count -gt 0) {
            Write-Host ""
            Write-Host "=== エラー詳細 ===" -ForegroundColor Red
            $errors | ForEach-Object { Write-Host $_ -ForegroundColor Red }
        }
        
    }
    catch {
        Write-Host "デバッグ実行エラー: $_" -ForegroundColor Red
        throw
    }
}

# 使用例
Debug-UnattendGeneration -PresetName "Development" -OutputPath ".\debug_test.xml"
```

#### パターン2: 段階的実行テスト
```powershell
# 段階的な動作確認スクリプト
function Test-UnattendGenerationStep {
    Write-Host "=== 段階的動作確認 ===" -ForegroundColor Cyan
    
    # Step 1: システム要件確認
    Write-Host "Step 1: システム要件確認" -ForegroundColor Yellow
    $psVersion = $PSVersionTable.PSVersion
    $executionPolicy = Get-ExecutionPolicy
    Write-Host "PowerShell: $psVersion" -ForegroundColor Gray
    Write-Host "実行ポリシー: $executionPolicy" -ForegroundColor Gray
    
    # Step 2: ファイル存在確認
    Write-Host "Step 2: ファイル存在確認" -ForegroundColor Yellow
    $requiredFiles = @(
        ".\Generate-UnattendXML.ps1",
        ".\Generate-UnattendXML.psm1",
        ".\Configs\Presets\Development.psd1"
    )
    
    foreach ($file in $requiredFiles) {
        $exists = Test-Path $file
        $status = if ($exists) { "✅" } else { "❌" }
        Write-Host "$status $file" -ForegroundColor $(if ($exists) { "Green" } else { "Red" })
    }
    
    # Step 3: モジュールインポートテスト
    Write-Host "Step 3: モジュールインポート" -ForegroundColor Yellow
    try {
        Import-Module ".\Generate-UnattendXML.psm1" -Force
        Write-Host "✅ モジュールインポート成功" -ForegroundColor Green
    }
    catch {
        Write-Host "❌ モジュールインポート失敗: $_" -ForegroundColor Red
        return
    }
    
    # Step 4: プリセット読み込みテスト
    Write-Host "Step 4: プリセット読み込み" -ForegroundColor Yellow
    try {
        $config = Import-UnattendPreset -PresetName "Development"
        Write-Host "✅ プリセット読み込み成功" -ForegroundColor Green
        Write-Host "   ホスト名: $($config.System.HostName)" -ForegroundColor Gray
        Write-Host "   ユーザー数: $($config.Users.Count)" -ForegroundColor Gray
    }
    catch {
        Write-Host "❌ プリセット読み込み失敗: $_" -ForegroundColor Red
        return
    }
    
    # Step 5: WhatIfテスト
    Write-Host "Step 5: WhatIf実行テスト" -ForegroundColor Yellow
    try {
        .\Generate-UnattendXML.ps1 -PresetName "Development" -WhatIf
        Write-Host "✅ WhatIf実行成功" -ForegroundColor Green
    }
    catch {
        Write-Host "❌ WhatIf実行失敗: $_" -ForegroundColor Red
        return
    }
    
    # Step 6: 実際のXML生成テスト
    Write-Host "Step 6: XML生成テスト" -ForegroundColor Yellow
    try {
        $testOutput = ".\test_generation.xml"
        $result = .\Generate-UnattendXML.ps1 -PresetName "Development" -OutputPath $testOutput -Force
        
        if (Test-Path $result) {
            $fileSize = (Get-Item $result).Length
            Write-Host "✅ XML生成成功" -ForegroundColor Green
            Write-Host "   ファイル: $result" -ForegroundColor Gray
            Write-Host "   サイズ: $fileSize bytes" -ForegroundColor Gray
            
            # テストファイル削除
            Remove-Item $result -Force
        } else {
            Write-Host "❌ XMLファイルが生成されませんでした" -ForegroundColor Red
        }
    }
    catch {
        Write-Host "❌ XML生成失敗: $_" -ForegroundColor Red
        return
    }
    
    Write-Host ""
    Write-Host "✅ すべての段階的テストが完了しました" -ForegroundColor Green
}

# 使用例
Test-UnattendGenerationStep
```

---

*このコマンドリファレンスは、Windows 11 Sysprep応答ファイル自動生成システム（PowerShell版）のすべてのコマンド、関数、パラメーターについて詳細に説明しています。実際の業務でご活用ください。*