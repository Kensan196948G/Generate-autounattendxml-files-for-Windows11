# PowerShell版 v2.0 詳細利用手順書

## 目次
1. [基本的な使用方法](#基本的な使用方法)
2. [対話モード（Interactive Mode）](#対話モードinteractive-mode)
3. [プリセット使用](#プリセット使用)
4. [設定ファイルの作成と使用](#設定ファイルの作成と使用)
5. [全23項目の設定詳細](#全23項目の設定詳細)
6. [並列処理とパフォーマンス最適化](#並列処理とパフォーマンス最適化)
7. [高度な使用例](#高度な使用例)
8. [生成されたXMLの確認と検証](#生成されたxmlの確認と検証)

---

## 基本的な使用方法

### コマンドライン基本構文
```powershell
.\Generate-UnattendXML-V2.ps1 [パラメータ]
```

### 主要パラメータ一覧
| パラメータ | 説明 | 例 |
|-----------|------|-----|
| `-Interactive` | 対話モードで起動 | `-Interactive` |
| `-Preset` | プリセット名を指定 | `-Preset Enterprise` |
| `-ConfigFile` | 設定ファイルパス | `-ConfigFile .\config.json` |
| `-OutputPath` | 出力先パス | `-OutputPath C:\Temp` |
| `-EnableParallel` | 並列処理有効化 | `-EnableParallel` |
| `-MaxThreads` | 最大スレッド数 | `-MaxThreads 8` |
| `-GenerateLog` | ログ生成有効化 | `-GenerateLog` |
| `-ValidateOnly` | 検証のみ実行 | `-ValidateOnly` |
| `-Verbose` | 詳細出力 | `-Verbose` |
| `-Debug` | デバッグモード | `-Debug` |

---

## 対話モード（Interactive Mode）

### 1. 対話モードの起動
```powershell
.\Generate-UnattendXML-V2.ps1 -Interactive
```

### 2. 対話フロー例
```
================================================================================
 Windows 11 無人応答ファイル生成システム v2.0
 対話モード
================================================================================

[1. 基本設定]
地域と言語を選択してください:
  1) 日本 (ja-JP)
  2) 米国 (en-US)
  3) カスタム
選択 [1]: 1

プロセッサアーキテクチャを選択してください:
  1) amd64 (64ビット)
  2) x86 (32ビット)
選択 [1]: 1

[2. コンピューター設定]
コンピューター名を入力してください [DESKTOP-PC]: WIN11-PC001
ドメインに参加しますか？ (Y/N) [N]: N

[3. ユーザーアカウント]
管理者アカウントを作成しますか？ (Y/N) [Y]: Y
ユーザー名: admin-user
パスワード: ********
パスワード確認: ********

[4. ネットワーク設定]
Wi-Fiを設定しますか？ (Y/N) [Y]: Y
SSID: 20mirai18
パスワード: ********
セキュリティタイプ:
  1) WPA2-Personal
  2) WPA3-Personal
  3) Open
選択 [1]: 1

... (続く)

[確認]
設定内容を確認してください:
- 地域と言語: 日本 (ja-JP)
- アーキテクチャ: amd64
- コンピューター名: WIN11-PC001
- 管理者アカウント: admin-user
- Wi-Fi SSID: 20mirai18

この設定でXMLを生成しますか？ (Y/N): Y

生成中...
✓ XML生成完了: C:\Tools\Generate-UnattendXML\Outputs\unattend_20240824_143025.xml
```

### 3. 対話モードのスキップオプション
```powershell
# デフォルト値を使用して高速に進む
.\Generate-UnattendXML-V2.ps1 -Interactive -UseDefaults

# 特定のセクションのみ対話的に設定
.\Generate-UnattendXML-V2.ps1 -Interactive -Sections "UserAccounts,Network"
```

---

## プリセット使用

### 1. 利用可能なプリセット

#### Enterprise（企業向け）
```powershell
.\Generate-UnattendXML-V2.ps1 -Preset Enterprise -OutputPath .\Outputs
```

**特徴:**
- セキュリティ重視設定
- 複数管理者アカウント
- ドメイン参加準備
- グループポリシー対応
- リモートデスクトップ有効

#### Development（開発者向け）
```powershell
.\Generate-UnattendXML-V2.ps1 -Preset Development -OutputPath .\Outputs
```

**特徴:**
- 開発ツール有効化
- Hyper-V、WSL2有効
- Windows Sandbox有効
- 開発者モード有効
- PowerShell ISE有効

#### Minimal（最小構成）
```powershell
.\Generate-UnattendXML-V2.ps1 -Preset Minimal -OutputPath .\Outputs
```

**特徴:**
- 軽量・高速起動
- 不要サービス無効化
- 視覚効果最小化
- プライバシー保護
- リソース使用最小化

### 2. プリセットのカスタマイズ
```powershell
# プリセットをベースにカスタマイズ
$config = Get-UnattendPreset -Name Enterprise
$config.ComputerSettings.ComputerName = "CUSTOM-PC"
$config.UserAccounts.Accounts[0].Username = "custom-admin"

.\Generate-UnattendXML-V2.ps1 -Config $config -OutputPath .\Outputs
```

---

## 設定ファイルの作成と使用

### 1. JSON形式の設定ファイル

#### 設定ファイル例（custom-config.json）
```json
{
  "RegionalSettings": {
    "InputLocale": "0411:00000411",
    "SystemLocale": "ja-JP",
    "UILanguage": "ja-JP",
    "UserLocale": "ja-JP"
  },
  "ComputerSettings": {
    "ComputerName": "WIN11-CUSTOM",
    "JoinDomain": false,
    "TimeZone": "Tokyo Standard Time"
  },
  "UserAccounts": {
    "Accounts": [
      {
        "Username": "admin",
        "Password": "Admin2024!",
        "Group": "Administrators",
        "Description": "管理者アカウント",
        "AutoLogon": true,
        "AutoLogonCount": 1
      },
      {
        "Username": "user",
        "Password": "User2024!",
        "Group": "Users",
        "Description": "標準ユーザー"
      }
    ]
  },
  "NetworkConfiguration": {
    "DisableIPv6": true,
    "DisableFirewall": false,
    "WiFiConfig": {
      "SSID": "20mirai18",
      "Password": "20m!ra!18",
      "SecurityType": "WPA2-Personal",
      "AutoConnect": true
    }
  },
  "WindowsFeatures": {
    "EnableDotNet35": true,
    "EnableHyperV": false,
    "EnableWSL": true,
    "EnableSandbox": false
  },
  "ApplicationSettings": {
    "RemoveApps": [
      "Microsoft.BingNews",
      "Microsoft.BingWeather",
      "Microsoft.XboxApp"
    ],
    "DefaultBrowser": "Edge",
    "DefaultPDFReader": "Edge"
  },
  "SystemOptimization": {
    "DisableTelemetry": true,
    "DisableWindowsDefender": false,
    "SetUACLevel": "Default",
    "VisualEffects": "BestPerformance"
  }
}
```

#### 使用方法
```powershell
.\Generate-UnattendXML-V2.ps1 -ConfigFile ".\custom-config.json" -OutputPath .\Outputs
```

### 2. PowerShellデータファイル（PSD1）形式

#### 設定ファイル例（custom-config.psd1）
```powershell
@{
    RegionalSettings = @{
        InputLocale = "0411:00000411"
        SystemLocale = "ja-JP"
        UILanguage = "ja-JP"
        UserLocale = "ja-JP"
    }
    
    ComputerSettings = @{
        ComputerName = "WIN11-CUSTOM"
        JoinDomain = $false
        TimeZone = "Tokyo Standard Time"
    }
    
    UserAccounts = @{
        Accounts = @(
            @{
                Username = "admin"
                Password = "Admin2024!"
                Group = "Administrators"
                Description = "管理者アカウント"
            }
        )
    }
    
    EnableParallel = $true
    MaxThreads = 8
}
```

#### 使用方法
```powershell
.\Generate-UnattendXML-V2.ps1 -ConfigFile ".\custom-config.psd1" -OutputPath .\Outputs
```

---

## 全23項目の設定詳細

### 項目1-11: 基本設定
```powershell
$basicConfig = @{
    # 1. 地域と言語
    RegionalSettings = @{
        InputLocale = "0411:00000411"
        SystemLocale = "ja-JP"
        UILanguage = "ja-JP"
        UserLocale = "ja-JP"
    }
    
    # 2. プロセッサアーキテクチャ
    ProcessorArchitecture = "amd64"
    
    # 3. セットアップUI
    SetupUILanguage = @{
        UILanguage = "ja-JP"
        WillShowUI = "OnError"
    }
    
    # 4. Windowsエディション
    ImageInstall = @{
        OSImage = @{
            WillShowUI = "OnError"
            InstallFrom = @{
                MetaData = @{
                    Key = "/IMAGE/NAME"
                    Value = "Windows 11 Pro"
                }
            }
        }
    }
    
    # 5. Windows PE設定
    WindowsPE = @{
        EnableNetwork = $true
        EnableFirewall = $false
    }
    
    # 6. ディスク構成
    DiskConfiguration = @{
        WillWipeDisk = $true
        Disk = @{
            DiskID = 0
            Partitions = @(
                @{
                    Order = 1
                    Size = 500
                    Type = "EFI"
                }
                @{
                    Order = 2
                    Size = 128
                    Type = "MSR"
                }
                @{
                    Order = 3
                    Extend = $true
                    Type = "Primary"
                }
            )
        }
    }
    
    # 7. コンピューター名
    ComputerName = "WIN11-PC"
    
    # 8. ユーザーアカウント
    UserAccounts = @{
        LocalAccounts = @(
            @{
                Name = "admin"
                Password = "Admin2024!"
                Group = "Administrators"
            }
        )
    }
    
    # 9. エクスプローラー設定
    ExplorerSettings = @{
        ShowFileExtensions = $true
        ShowHiddenFiles = $false
        ShowSystemFiles = $false
    }
    
    # 10. スタートメニュー/タスクバー
    StartMenuTaskbar = @{
        DisableNewsAndInterests = $true
        TaskbarAlignment = "Left"
        DisableWidgets = $true
    }
    
    # 11. システム調整
    SystemTweaks = @{
        DisableTelemetry = $true
        DisableAdvertisingID = $true
        DisableLocationTracking = $true
    }
}
```

### 項目12-23: 拡張設定
```powershell
$advancedConfig = @{
    # 12. 視覚効果
    VisualEffects = @{
        PerformanceMode = "BestPerformance"
        DisableAnimations = $true
        DisableTransparency = $true
    }
    
    # 13. デスクトップアイコン
    DesktopIcons = @{
        ShowThisPC = $true
        ShowUserFolder = $true
        ShowNetwork = $true
        ShowRecycleBin = $true
        ShowControlPanel = $false
    }
    
    # 14. 仮想マシンサポート
    VMSupport = @{
        EnableHyperV = $true
        EnableWSL = $true
        EnableVirtualMachinePlatform = $true
        EnableWindowsSandbox = $true
    }
    
    # 15. Wi-Fi設定
    WiFiConfig = @{
        SSID = "20mirai18"
        Password = "20m!ra!18"
        SecurityType = "WPA2Personal"
        AutoConnect = $true
    }
    
    # 16. Express Settings
    ExpressSettings = @{
        EnableOneDrive = $false
        ProtectPC = "DisableProtection"
        SendInfo = "DoNotSend"
        GetUpdates = "DisableAutomaticUpdates"
    }
    
    # 17. ロックキー
    LockKeys = @{
        DisableCapsLock = $false
        DisableNumLock = $false
        DisableScrollLock = $true
    }
    
    # 18. 固定キー
    StickyKeys = @{
        Disable = $true
        DisableHotkey = $true
    }
    
    # 19. 個人用設定
    Personalization = @{
        AccentColor = "0x00d7c378"
        EnableDarkMode = $true
        BackgroundImage = "C:\\Windows\\Web\\Wallpaper\\Windows\\img0.jpg"
    }
    
    # 20. アプリの削除
    RemoveApps = @{
        Apps = @(
            "Microsoft.BingNews",
            "Microsoft.BingWeather",
            "Microsoft.GetHelp",
            "Microsoft.Getstarted",
            "Microsoft.Microsoft3DViewer",
            "Microsoft.MicrosoftSolitaireCollection",
            "Microsoft.MixedReality.Portal",
            "Microsoft.Office.OneNote",
            "Microsoft.People",
            "Microsoft.SkypeApp",
            "Microsoft.Wallet",
            "Microsoft.Xbox.TCUI",
            "Microsoft.XboxApp",
            "Microsoft.XboxGameOverlay",
            "Microsoft.XboxGamingOverlay",
            "Microsoft.XboxIdentityProvider",
            "Microsoft.XboxSpeechToTextOverlay",
            "Microsoft.YourPhone",
            "Microsoft.ZuneMusic",
            "Microsoft.ZuneVideo"
        )
    }
    
    # 21. カスタムスクリプト
    CustomScripts = @{
        PowerShellScripts = @(
            "C:\\Scripts\\CustomSetup.ps1",
            "C:\\Scripts\\InstallTools.ps1"
        )
        BatchScripts = @(
            "C:\\Scripts\\NetworkConfig.bat"
        )
    }
    
    # 22. Windows Defender Application Control
    WDAC = @{
        EnableWDAC = $false
        PolicyFile = "C:\\Windows\\System32\\CodeIntegrity\\SIPolicy.p7b"
    }
    
    # 23. 追加コンポーネント
    AdditionalComponents = @{
        OpenSSHClient = $true
        OpenSSHServer = $false
        TelnetClient = $false
        TFTPClient = $false
        WindowsMediaPlayer = $true
    }
}
```

---

## 並列処理とパフォーマンス最適化

### 1. Claude-flow並列処理の有効化
```powershell
# 最大8スレッドで並列処理
.\Generate-UnattendXML-V2.ps1 -Preset Enterprise -EnableParallel -MaxThreads 8

# CPU数に応じて自動調整
.\Generate-UnattendXML-V2.ps1 -Preset Enterprise -EnableParallel -MaxThreads ([Environment]::ProcessorCount)
```

### 2. パフォーマンス測定
```powershell
# パフォーマンス測定付き実行
Measure-Command {
    .\Generate-UnattendXML-V2.ps1 -Preset Enterprise -EnableParallel
} | Select-Object TotalSeconds

# 詳細なパフォーマンスログ
.\Generate-UnattendXML-V2.ps1 -Preset Enterprise -EnableParallel -PerformanceLog
```

### 3. メモリ最適化
```powershell
# メモリ使用量を制限
$job = Start-Job -ScriptBlock {
    Set-Item WSMan:\localhost\Shell\MaxMemoryPerShellMB 512
    & ".\Generate-UnattendXML-V2.ps1" -Preset Enterprise
}
Wait-Job $job
Receive-Job $job
```

---

## 高度な使用例

### 1. 複数の設定ファイルをマージ
```powershell
# 基本設定とカスタム設定をマージ
$baseConfig = Get-Content ".\Configs\base.json" | ConvertFrom-Json
$customConfig = Get-Content ".\Configs\custom.json" | ConvertFrom-Json

$mergedConfig = Merge-UnattendConfig -Base $baseConfig -Custom $customConfig
.\Generate-UnattendXML-V2.ps1 -Config $mergedConfig -OutputPath .\Outputs
```

### 2. バッチ処理（複数PC用）
```powershell
# PC名リストから一括生成
$pcList = @("PC001", "PC002", "PC003", "PC004", "PC005")

foreach ($pcName in $pcList) {
    $config = Get-UnattendPreset -Name Enterprise
    $config.ComputerSettings.ComputerName = "WIN11-$pcName"
    
    .\Generate-UnattendXML-V2.ps1 -Config $config -OutputPath ".\Outputs\$pcName.xml"
    Write-Host "✓ Generated: $pcName.xml" -ForegroundColor Green
}
```

### 3. 条件付き設定
```powershell
# 環境に応じた設定変更
$environment = Read-Host "環境を選択 (Dev/Test/Prod)"

$config = switch ($environment) {
    "Dev" {
        Get-UnattendPreset -Name Development
    }
    "Test" {
        $c = Get-UnattendPreset -Name Enterprise
        $c.SystemOptimization.DisableWindowsDefender = $true
        $c
    }
    "Prod" {
        Get-UnattendPreset -Name Enterprise
    }
    default {
        Get-UnattendPreset -Name Minimal
    }
}

.\Generate-UnattendXML-V2.ps1 -Config $config -OutputPath .\Outputs
```

### 4. PowerShellリモーティング経由での実行
```powershell
# リモートマシンでXML生成
$session = New-PSSession -ComputerName "RemoteServer"
Copy-Item -Path ".\PowerShell" -Destination "C:\Temp" -ToSession $session -Recurse

Invoke-Command -Session $session -ScriptBlock {
    cd "C:\Temp\PowerShell"
    .\Generate-UnattendXML-V2.ps1 -Preset Enterprise -OutputPath "C:\Temp"
}

Copy-Item -Path "C:\Temp\unattend*.xml" -FromSession $session -Destination ".\RemoteOutputs"
Remove-PSSession $session
```

---

## 生成されたXMLの確認と検証

### 1. XML構造の確認
```powershell
# 生成されたXMLを読み込み
[xml]$xml = Get-Content ".\Outputs\unattend_20240824_143025.xml"

# 設定パスの確認
$xml.unattend.settings | ForEach-Object {
    Write-Host "Pass: $($_.pass)" -ForegroundColor Cyan
    $_.component | ForEach-Object {
        Write-Host "  Component: $($_.name)" -ForegroundColor Yellow
    }
}
```

### 2. FirstLogonCommandsの確認
```powershell
# FirstLogonCommandsの一覧表示
$commands = $xml.unattend.settings | 
    Where-Object { $_.pass -eq "oobeSystem" } | 
    Select-Object -ExpandProperty component | 
    Where-Object { $_.name -like "*Shell-Setup*" } | 
    Select-Object -ExpandProperty FirstLogonCommands | 
    Select-Object -ExpandProperty SynchronousCommand

$commands | ForEach-Object {
    Write-Host "$($_.Order): $($_.CommandLine)" -ForegroundColor Green
}
```

### 3. XMLスキーマ検証
```powershell
# スキーマ検証の実行
.\Generate-UnattendXML-V2.ps1 -ValidateOnly -XmlPath ".\Outputs\unattend_20240824_143025.xml"

# 詳細な検証結果
$validationResult = Test-UnattendXML -Path ".\Outputs\unattend_20240824_143025.xml" -Verbose
if ($validationResult.IsValid) {
    Write-Host "✓ XML検証成功" -ForegroundColor Green
} else {
    Write-Host "✗ XML検証失敗:" -ForegroundColor Red
    $validationResult.Errors | ForEach-Object {
        Write-Host "  - $_" -ForegroundColor Yellow
    }
}
```

### 4. 設定値の抽出
```powershell
# 特定の設定値を抽出
$computerName = $xml.unattend.settings | 
    Where-Object { $_.pass -eq "specialize" } | 
    Select-Object -ExpandProperty component | 
    Where-Object { $_.name -like "*Shell-Setup*" } | 
    Select-Object -ExpandProperty ComputerName

Write-Host "コンピューター名: $computerName"

# ユーザーアカウントの確認
$users = $xml.unattend.settings | 
    Where-Object { $_.pass -eq "oobeSystem" } | 
    Select-Object -ExpandProperty component | 
    Where-Object { $_.name -like "*Shell-Setup*" } | 
    Select-Object -ExpandProperty UserAccounts | 
    Select-Object -ExpandProperty LocalAccounts | 
    Select-Object -ExpandProperty LocalAccount

$users | ForEach-Object {
    Write-Host "ユーザー: $($_.Name) (グループ: $($_.Group))"
}
```

---

## トラブルシューティング

### よくある質問と回答

**Q: 生成されたXMLが大きすぎる**
```powershell
# 最小構成で生成
.\Generate-UnattendXML-V2.ps1 -Preset Minimal -CompactMode
```

**Q: 特定の設定項目だけを含めたい**
```powershell
# 必要な項目のみ指定
.\Generate-UnattendXML-V2.ps1 -Interactive -IncludeOnly "UserAccounts,Network,WindowsFeatures"
```

**Q: 生成速度を向上させたい**
```powershell
# SubAgentのキャッシュを有効化
.\Generate-UnattendXML-V2.ps1 -Preset Enterprise -EnableCache -CachePath ".\Cache"
```

---

## 次のステップ

1. **[SubAgentリファレンス.md](./SubAgentリファレンス.md)** - 42体のSubAgentの詳細
2. **[設定リファレンス_v2.md](./設定リファレンス_v2.md)** - 全設定項目の詳細
3. **[トラブルシューティングガイド_v2.md](./トラブルシューティングガイド_v2.md)** - 問題解決ガイド

---

*最終更新: 2024年8月24日 | バージョン: 2.0.0*