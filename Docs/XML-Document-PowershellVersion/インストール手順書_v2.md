# PowerShell版 v2.0 インストール手順書

## 目次
1. [システム要件](#システム要件)
2. [前提条件の確認](#前提条件の確認)
3. [インストール手順](#インストール手順)
4. [初期設定](#初期設定)
5. [動作確認](#動作確認)
6. [トラブルシューティング](#トラブルシューティング)

---

## システム要件

### 必須要件
| 項目 | 要件 |
|------|------|
| OS | Windows 10 (1809以降) / Windows 11 / Windows Server 2019/2022 |
| PowerShell | 5.1以降（PowerShell 7.x推奨） |
| .NET Framework | 4.7.2以降 |
| メモリ | 4GB以上（8GB推奨） |
| ディスク容量 | 500MB以上 |
| CPU | 64ビットプロセッサー（マルチコア推奨） |

### 推奨環境
- **PowerShell 7.4以降**: 最新の言語機能とパフォーマンス改善
- **Windows 11 23H2**: 最新のWindows API対応
- **SSD**: 高速なファイルI/O処理

---

## 前提条件の確認

### 1. PowerShellバージョン確認
```powershell
# PowerShellバージョンの確認
$PSVersionTable.PSVersion

# 期待される出力（例）
Major  Minor  Build  Revision
-----  -----  -----  --------
5      1      22621  2506
```

### 2. 実行ポリシーの確認
```powershell
# 現在の実行ポリシー確認
Get-ExecutionPolicy -List

# 必要に応じて実行ポリシーを変更
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

### 3. .NET Frameworkバージョン確認
```powershell
# .NET Frameworkバージョン確認
Get-ItemProperty "HKLM:SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full\" | Select Release, Version

# Release値の対応表
# 461808 = .NET Framework 4.7.2
# 528040 = .NET Framework 4.8
# 533320 = .NET Framework 4.8.1
```

### 4. 管理者権限の確認
```powershell
# 管理者権限での実行確認
([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
```

---

## インストール手順

### ステップ1: ファイルのダウンロード

#### GitHubからのクローン（推奨）
```powershell
# プロジェクトのクローン
git clone https://github.com/your-org/Generate-autounattendxml-files-for-Windows11.git
cd Generate-autounattendxml-files-for-Windows11\PowerShell
```

#### ZIPファイルからの展開
```powershell
# ZIPファイルをダウンロード後
Expand-Archive -Path ".\PowerShell-v2.0.zip" -DestinationPath "C:\Tools\Generate-UnattendXML"
cd "C:\Tools\Generate-UnattendXML\PowerShell"
```

### ステップ2: ディレクトリ構造の確認
```powershell
# ディレクトリ構造の確認
Get-ChildItem -Recurse -Directory | Select-Object FullName

# 期待される構造
PowerShell\
├── Generate-UnattendXML-V2.ps1
├── Configs\
│   └── Presets\
├── Modules\
│   ├── ClaudeFlow\
│   ├── Context7\
│   ├── SubAgentLoader\
│   └── XMLGenerator\
├── Outputs\
├── Logs\
└── Tests\
```

### ステップ3: モジュールの検証
```powershell
# モジュール検証スクリプトの実行
.\Tests\Validate-Installation.ps1

# または手動で各モジュールを確認
$modules = @(
    "ClaudeFlow",
    "Context7", 
    "SubAgentLoader",
    "XMLGeneratorV2"
)

foreach ($module in $modules) {
    try {
        Import-Module ".\Modules\$module\$module.psm1" -Force
        Write-Host "✓ $module モジュール: OK" -ForegroundColor Green
    }
    catch {
        Write-Host "✗ $module モジュール: エラー" -ForegroundColor Red
        Write-Host "  詳細: $_" -ForegroundColor Yellow
    }
}
```

### ステップ4: 依存関係のインストール（必要な場合）
```powershell
# PowerShell 7のインストール（オプション）
winget install Microsoft.PowerShell

# Pesterテストフレームワーク（開発用）
Install-Module -Name Pester -Force -SkipPublisherCheck

# PSScriptAnalyzer（コード品質チェック用）
Install-Module -Name PSScriptAnalyzer -Force
```

---

## 初期設定

### 1. 環境変数の設定（オプション）
```powershell
# システム環境変数に追加（管理者権限必要）
[Environment]::SetEnvironmentVariable("UNATTEND_XML_PATH", "C:\Tools\Generate-UnattendXML\PowerShell", "Machine")

# ユーザー環境変数に追加
[Environment]::SetEnvironmentVariable("UNATTEND_XML_PATH", "C:\Tools\Generate-UnattendXML\PowerShell", "User")
```

### 2. エイリアスの作成（オプション）
```powershell
# PowerShellプロファイルに追加
Add-Content $PROFILE @"
# Generate-UnattendXML エイリアス
Set-Alias -Name genxml -Value "C:\Tools\Generate-UnattendXML\PowerShell\Generate-UnattendXML-V2.ps1"
"@
```

### 3. 初期設定ファイルの作成
```powershell
# カスタム設定ファイルの作成
$customConfig = @{
    DefaultPreset = "Enterprise"
    OutputDirectory = ".\Outputs"
    LogLevel = "Info"
    EnableParallel = $true
    MaxThreads = 8
}

$customConfig | ConvertTo-Json | Set-Content ".\Configs\default.json"
```

---

## 動作確認

### 1. 基本動作テスト
```powershell
# ヘルプの表示
Get-Help .\Generate-UnattendXML-V2.ps1 -Detailed

# バージョン確認
.\Generate-UnattendXML-V2.ps1 -Version

# 簡易テスト実行
.\Generate-UnattendXML-V2.ps1 -TestMode
```

### 2. SubAgent動作確認
```powershell
# SubAgentテストの実行
.\Tests\Test-SubAgents.ps1

# 期待される出力
Testing 42 SubAgents...
✓ UserCreationAgent: OK
✓ NetworkConfigAgent: OK
✓ RegistryAgent: OK
... (全42体のテスト結果)
```

### 3. Claude-flow並列処理テスト
```powershell
# 並列処理テスト
.\Tests\Test-ClaudeFlow.ps1

# 期待される出力
Claude-flow Engine Test
- Max Threads: 8
- RunspacePool: Initialized
- Parallel Jobs: 10
- Execution Time: 523ms
✓ All tests passed
```

### 4. XML生成テスト
```powershell
# Minimalプリセットでテスト
.\Generate-UnattendXML-V2.ps1 -Preset Minimal -OutputPath ".\test_output.xml"

# 生成されたXMLの検証
[xml]$xml = Get-Content ".\test_output.xml"
$xml.unattend.settings.Count  # 設定セクション数の確認
```

---

## トラブルシューティング

### よくある問題と解決方法

#### 1. 実行ポリシーエラー
```
エラー: このシステムではスクリプトの実行が無効になっています
```
**解決方法:**
```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
```

#### 2. モジュールインポートエラー
```
エラー: 指定されたモジュール 'ClaudeFlow' が読み込まれませんでした
```
**解決方法:**
```powershell
# モジュールパスの確認
$env:PSModulePath -split ';'

# モジュールを手動でインポート
Import-Module ".\Modules\ClaudeFlow\ClaudeFlow.psm1" -Force -Verbose
```

#### 3. メモリ不足エラー
```
エラー: 使用可能なメモリが不足しています
```
**解決方法:**
```powershell
# スレッド数を減らす
.\Generate-UnattendXML-V2.ps1 -MaxThreads 4

# またはメモリのクリア
[System.GC]::Collect()
[System.GC]::WaitForPendingFinalizers()
```

#### 4. ファイルアクセス権限エラー
```
エラー: パス 'Outputs\unattend.xml' へのアクセスが拒否されました
```
**解決方法:**
```powershell
# 管理者権限でPowerShellを起動
Start-Process powershell -Verb RunAs

# または出力先を変更
.\Generate-UnattendXML-V2.ps1 -OutputPath "$env:TEMP\unattend.xml"
```

### ログファイルの確認
```powershell
# 最新のログファイルを表示
Get-Content (Get-ChildItem ".\Logs" -Filter "*.log" | Sort-Object LastWriteTime -Descending | Select-Object -First 1).FullName -Tail 50
```

### デバッグモードでの実行
```powershell
# 詳細なデバッグ情報を表示
$DebugPreference = "Continue"
.\Generate-UnattendXML-V2.ps1 -Preset Enterprise -Debug
```

---

## アンインストール

### 完全削除
```powershell
# プロジェクトフォルダの削除
Remove-Item -Path "C:\Tools\Generate-UnattendXML" -Recurse -Force

# 環境変数の削除
[Environment]::SetEnvironmentVariable("UNATTEND_XML_PATH", $null, "User")

# プロファイルからエイリアスを削除
(Get-Content $PROFILE) | Where-Object { $_ -notmatch "Generate-UnattendXML" } | Set-Content $PROFILE
```

---

## 次のステップ

インストールが完了したら、以下のドキュメントを参照してください：

1. **[詳細利用手順書_v2.md](./詳細利用手順書_v2.md)** - 詳細な使用方法
2. **[設定リファレンス_v2.md](./設定リファレンス_v2.md)** - 設定項目の詳細
3. **[SubAgentリファレンス.md](./SubAgentリファレンス.md)** - SubAgentの詳細仕様

---

*最終更新: 2024年8月24日 | バージョン: 2.0.0*