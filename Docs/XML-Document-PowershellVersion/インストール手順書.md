# Windows 11 Sysprep応答ファイル自動生成システム（PowerShell版）
## インストール手順書

### 目次
1. [前提条件の確認](#前提条件の確認)
2. [システム要件](#システム要件)
3. [インストール手順](#インストール手順)
4. [初期設定](#初期設定)
5. [動作確認方法](#動作確認方法)
6. [トラブルシューティング](#トラブルシューティング)
7. [アンインストール方法](#アンインストール方法)

---

## 前提条件の確認

### 必要な知識・スキル
- **PowerShell基本操作**: PowerShellコマンドレットの基本的な使用方法
- **Windows管理**: Windows設定項目の基本的な理解
- **XML基礎知識**: unattend.xmlファイルの概念理解（推奨）

### 作業環境チェックリスト
- [ ] 管理者権限でのログインが可能
- [ ] PowerShell実行ポリシーの変更が可能
- [ ] インターネット接続がある（推奨）
- [ ] ウイルス対策ソフトによるブロックがない

---

## システム要件

### オペレーティングシステム要件

#### サポート対象OS
| OS | バージョン | サポート状況 |
|---|-----------|-------------|
| Windows 10 | 1809以降 | ✅ フルサポート |
| Windows 11 | 全バージョン | ✅ フルサポート |
| Windows Server 2019 | 全バージョン | ✅ フルサポート |
| Windows Server 2022 | 全バージョン | ✅ フルサポート |

#### PowerShell要件
| 項目 | 最小要件 | 推奨要件 |
|-----|----------|----------|
| PowerShell バージョン | 5.1 | 5.1 最新 |
| .NET Framework | 4.7.2以降 | 4.8以降 |
| 実行ポリシー | RemoteSigned | RemoteSigned |

#### ハードウェア要件
| リソース | 最小要件 | 推奨要件 | 備考 |
|---------|----------|----------|------|
| CPU | 64bit プロセッサー | マルチコア | 並列処理でパフォーマンス向上 |
| メモリ | 4GB | 8GB以上 | XMLファイルサイズに依存 |
| ストレージ | 100MB空き容量 | 1GB以上 | ログとテンポラリファイル用 |
| ネットワーク | 不要 | ブロードバンド接続 | 更新確認とヘルプ表示用 |

---

## インストール手順

### Step 1: 事前準備

#### 1.1 PowerShell実行ポリシーの確認と設定
```powershell
# 現在の実行ポリシーを確認
Get-ExecutionPolicy -List

# RemoteSignedに設定（管理者権限で実行）
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope LocalMachine
```

#### 1.2 必要な.NETアセンブリの確認
```powershell
# .NET Framework バージョン確認
[System.Environment]::Version

# 必要なアセンブリの読み込みテスト
Add-Type -AssemblyName System.Xml
Add-Type -AssemblyName System.Security
Write-Host ".NET アセンブリは正常に読み込まれました" -ForegroundColor Green
```

#### 1.3 作業ディレクトリの作成
```powershell
# インストール先ディレクトリの作成
$InstallPath = "C:\Tools\Windows11-UnattendXML-Generator"
New-Item -Path $InstallPath -ItemType Directory -Force
Set-Location $InstallPath
```

### Step 2: ファイルのダウンロードと配置

#### 2.1 システムファイルのダウンロード
```powershell
# GitHubからファイルをダウンロード（例）
# または手動でファイルをコピー

# ファイル構造を確認
$RequiredFiles = @(
    "Generate-UnattendXML.ps1",
    "Generate-UnattendXML.psm1",
    "Modules\UserManagement\UserManagement.psm1",
    "Modules\NetworkConfig\NetworkConfig.psm1",
    "Modules\WindowsFeatures\WindowsFeatures.psm1",
    "Modules\ApplicationConfig\ApplicationConfig.psm1",
    "Modules\XMLGenerator\XMLGenerator.psm1",
    "Configs\Presets\Development.psd1",
    "Configs\Presets\Enterprise.psd1",
    "Configs\Presets\Minimal.psd1"
)

foreach ($file in $RequiredFiles) {
    $fullPath = Join-Path $InstallPath $file
    if (Test-Path $fullPath) {
        Write-Host "✅ $file が見つかりました" -ForegroundColor Green
    } else {
        Write-Host "❌ $file が見つかりません" -ForegroundColor Red
    }
}
```

#### 2.2 ディレクトリ構造の作成
```powershell
# 必要なディレクトリを作成
$Directories = @(
    "Configs\Presets",
    "Modules\UserManagement",
    "Modules\NetworkConfig", 
    "Modules\WindowsFeatures",
    "Modules\ApplicationConfig",
    "Modules\XMLGenerator",
    "Outputs",
    "Logs",
    "Tests"
)

foreach ($dir in $Directories) {
    $fullPath = Join-Path $InstallPath $dir
    New-Item -Path $fullPath -ItemType Directory -Force | Out-Null
    Write-Host "📁 ディレクトリ作成: $dir" -ForegroundColor Blue
}
```

### Step 3: 権限設定とセキュリティ設定

#### 3.1 ファイル権限の設定
```powershell
# 管理者グループに適切な権限を設定
$Path = $InstallPath
$Administrators = [System.Security.Principal.SecurityIdentifier]::new("S-1-5-32-544").Translate([System.Security.Principal.NTAccount])

$AccessRule = New-Object System.Security.AccessControl.FileSystemAccessRule(
    $Administrators,
    "FullControl",
    "ContainerInherit,ObjectInherit",
    "None",
    "Allow"
)

$Acl = Get-Acl $Path
$Acl.SetAccessRule($AccessRule)
Set-Acl $Path $Acl

Write-Host "✅ ファイル権限が設定されました" -ForegroundColor Green
```

#### 3.2 PowerShellモジュールの信頼設定
```powershell
# モジュールの信頼設定
$ModulePaths = Get-ChildItem -Path "$InstallPath\Modules" -Recurse -Filter "*.psm1"

foreach ($module in $ModulePaths) {
    # デジタル署名の確認（オプション）
    $signature = Get-AuthenticodeSignature $module.FullName
    Write-Host "モジュール: $($module.Name) - 署名: $($signature.Status)" -ForegroundColor Yellow
}
```

### Step 4: 環境変数の設定（オプション）

#### 4.1 PATH環境変数への追加
```powershell
# システムPATHに追加
$CurrentPath = [Environment]::GetEnvironmentVariable("Path", "Machine")
if ($CurrentPath -notlike "*$InstallPath*") {
    [Environment]::SetEnvironmentVariable(
        "Path", 
        "$CurrentPath;$InstallPath", 
        "Machine"
    )
    Write-Host "✅ PATH環境変数に追加されました" -ForegroundColor Green
} else {
    Write-Host "⚠️ PATH環境変数は既に設定されています" -ForegroundColor Yellow
}
```

#### 4.2 PowerShellプロファイルへの追加（推奨）
```powershell
# PowerShellプロファイルにモジュールパスを追加
$ProfilePath = $PROFILE.AllUsersAllHosts
if (!(Test-Path $ProfilePath)) {
    New-Item -Path $ProfilePath -Type File -Force
}

$ModulePath = "$InstallPath\Generate-UnattendXML.psm1"
$ImportLine = "Import-Module '$ModulePath' -DisableNameChecking"

$ProfileContent = Get-Content $ProfilePath -ErrorAction SilentlyContinue
if ($ProfileContent -notcontains $ImportLine) {
    Add-Content $ProfilePath $ImportLine
    Write-Host "✅ PowerShellプロファイルに追加されました" -ForegroundColor Green
}
```

---

## 初期設定

### Step 1: 基本設定の構成

#### 1.1 ログ設定
```powershell
# ログディレクトリの初期化
$LogPath = "$InstallPath\Logs"
$MaxLogFiles = 10
$MaxLogSizeMB = 10

# 古いログファイルのクリーンアップスクリプト（オプション）
$CleanupScript = @"
`$LogFiles = Get-ChildItem -Path '$LogPath' -Filter '*.log' | Sort-Object LastWriteTime -Descending
if (`$LogFiles.Count -gt $MaxLogFiles) {
    `$LogFiles | Select-Object -Skip $MaxLogFiles | Remove-Item -Force
}
"@

$CleanupScript | Out-File "$InstallPath\Cleanup-Logs.ps1" -Encoding UTF8
```

#### 1.2 出力ディレクトリの設定
```powershell
# 出力ディレクトリの権限設定
$OutputPath = "$InstallPath\Outputs"
$Users = [System.Security.Principal.SecurityIdentifier]::new("S-1-5-32-545").Translate([System.Security.Principal.NTAccount])

$AccessRule = New-Object System.Security.AccessControl.FileSystemAccessRule(
    $Users,
    "ReadAndExecute",
    "ContainerInherit,ObjectInherit",
    "None",
    "Allow"
)

$Acl = Get-Acl $OutputPath
$Acl.SetAccessRule($AccessRule)
Set-Acl $OutputPath $Acl
```

### Step 2: プリセット設定の検証

#### 2.1 プリセットファイルの整合性確認
```powershell
# プリセット設定の検証スクリプト
function Test-PresetConfiguration {
    param([string]$PresetPath)
    
    try {
        $config = Import-PowerShellDataFile -Path $PresetPath
        
        # 必須項目の確認
        $requiredKeys = @("System", "Users", "Applications")
        foreach ($key in $requiredKeys) {
            if (-not $config.ContainsKey($key)) {
                throw "必須項目が見つかりません: $key"
            }
        }
        
        Write-Host "✅ プリセット検証成功: $(Split-Path $PresetPath -Leaf)" -ForegroundColor Green
        return $true
    }
    catch {
        Write-Host "❌ プリセット検証失敗: $(Split-Path $PresetPath -Leaf) - $_" -ForegroundColor Red
        return $false
    }
}

# 全プリセットの検証
$PresetPath = "$InstallPath\Configs\Presets"
$PresetFiles = Get-ChildItem -Path $PresetPath -Filter "*.psd1"

foreach ($preset in $PresetFiles) {
    Test-PresetConfiguration -PresetPath $preset.FullName
}
```

### Step 3: ショートカットの作成（オプション）

#### 3.1 デスクトップショートカット
```powershell
# デスクトップにショートカットを作成
$WshShell = New-Object -ComObject WScript.Shell
$Shortcut = $WshShell.CreateShortcut("$env:PUBLIC\Desktop\Windows11 UnattendXML Generator.lnk")
$Shortcut.TargetPath = "powershell.exe"
$Shortcut.Arguments = "-ExecutionPolicy Bypass -File `"$InstallPath\Generate-UnattendXML.ps1`" -Interactive"
$Shortcut.WorkingDirectory = $InstallPath
$Shortcut.IconLocation = "powershell.exe,0"
$Shortcut.Description = "Windows 11 Sysprep UnattendXML Generator"
$Shortcut.Save()

Write-Host "✅ デスクトップショートカットを作成しました" -ForegroundColor Green
```

#### 3.2 スタートメニューショートカット
```powershell
# スタートメニューにショートカットを作成
$StartMenuPath = "$env:ProgramData\Microsoft\Windows\Start Menu\Programs\Administrative Tools"
if (!(Test-Path $StartMenuPath)) {
    New-Item -Path $StartMenuPath -ItemType Directory -Force
}

$Shortcut = $WshShell.CreateShortcut("$StartMenuPath\Windows11 UnattendXML Generator.lnk")
$Shortcut.TargetPath = "powershell.exe"
$Shortcut.Arguments = "-ExecutionPolicy Bypass -File `"$InstallPath\Generate-UnattendXML.ps1`" -Interactive"
$Shortcut.WorkingDirectory = $InstallPath
$Shortcut.IconLocation = "powershell.exe,0"
$Shortcut.Description = "Windows 11 Sysprep UnattendXML Generator"
$Shortcut.Save()

Write-Host "✅ スタートメニューショートカットを作成しました" -ForegroundColor Green
```

---

## 動作確認方法

### Step 1: 基本機能テスト

#### 1.1 モジュール読み込みテスト
```powershell
# インストールディレクトリに移動
Set-Location $InstallPath

# メインモジュールのインポートテスト
Import-Module ".\Generate-UnattendXML.psm1" -Force -Verbose

# モジュールが正常にインポートされたか確認
Get-Module | Where-Object Name -eq "Generate-UnattendXML"

Write-Host "✅ モジュールインポートテスト完了" -ForegroundColor Green
```

#### 1.2 プリセット読み込みテスト
```powershell
# 各プリセットの読み込みテスト
$PresetNames = @("Development", "Enterprise", "Minimal")

foreach ($presetName in $PresetNames) {
    try {
        $config = Import-UnattendPreset -PresetName $presetName
        Write-Host "✅ プリセット読み込み成功: $presetName" -ForegroundColor Green
        
        # 基本項目の確認
        Write-Host "   ホスト名: $($config.System.HostName)" -ForegroundColor Gray
        Write-Host "   ユーザー数: $($config.Users.Count)" -ForegroundColor Gray
    }
    catch {
        Write-Host "❌ プリセット読み込み失敗: $presetName - $_" -ForegroundColor Red
    }
}
```

#### 1.3 XML生成テスト（WhatIf モード）
```powershell
# WhatIfモードでのテスト実行
Write-Host "=== WhatIfモードでのテスト実行 ===" -ForegroundColor Cyan

try {
    .\Generate-UnattendXML.ps1 -PresetName "Development" -WhatIf -OutputPath ".\Outputs\test.xml"
    Write-Host "✅ WhatIf テスト成功" -ForegroundColor Green
}
catch {
    Write-Host "❌ WhatIf テスト失敗: $_" -ForegroundColor Red
}
```

### Step 2: 実際のファイル生成テスト

#### 2.1 Development プリセットでのテスト
```powershell
# Development設定でXML生成テスト
Write-Host "=== Development プリセット実行テスト ===" -ForegroundColor Cyan

try {
    $result = .\Generate-UnattendXML.ps1 -PresetName "Development" -OutputPath ".\Outputs\test-development.xml" -Force
    
    if (Test-Path $result) {
        $xmlContent = Get-Content $result -Raw
        $xmlDoc = [xml]$xmlContent
        
        Write-Host "✅ XML生成成功: $result" -ForegroundColor Green
        Write-Host "   ファイルサイズ: $((Get-Item $result).Length) bytes" -ForegroundColor Gray
        Write-Host "   XMLルート要素: $($xmlDoc.DocumentElement.LocalName)" -ForegroundColor Gray
    } else {
        Write-Host "❌ 生成されたファイルが見つかりません" -ForegroundColor Red
    }
}
catch {
    Write-Host "❌ XML生成テスト失敗: $_" -ForegroundColor Red
}
```

#### 2.2 XML妥当性検証テスト
```powershell
# 生成されたXMLファイルの妥当性検証
$testXmlPath = ".\Outputs\test-development.xml"

if (Test-Path $testXmlPath) {
    try {
        # XMLファイルの読み込みテスト
        [xml]$xmlDoc = Get-Content $testXmlPath -Raw
        
        # 基本的な構造確認
        $unattendElement = $xmlDoc.unattend
        if ($unattendElement -ne $null) {
            Write-Host "✅ XML構造検証成功" -ForegroundColor Green
            Write-Host "   名前空間: $($unattendElement.xmlns)" -ForegroundColor Gray
        } else {
            Write-Host "❌ unattend要素が見つかりません" -ForegroundColor Red
        }
    }
    catch {
        Write-Host "❌ XML妥当性検証失敗: $_" -ForegroundColor Red
    }
}
```

### Step 3: 対話型ウィザードテスト

#### 3.1 ウィザード起動テスト
```powershell
# ウィザードモードのテスト（手動実行）
Write-Host "=== 対話型ウィザードテスト ===" -ForegroundColor Cyan
Write-Host "以下のコマンドを手動で実行してウィザードをテストしてください:" -ForegroundColor Yellow
Write-Host ".\Generate-UnattendXML.ps1 -Interactive" -ForegroundColor White
Write-Host ""
Write-Host "期待される動作:" -ForegroundColor Yellow
Write-Host "1. プリセット選択メニューの表示" -ForegroundColor Gray
Write-Host "2. 矢印キーでの選択操作" -ForegroundColor Gray
Write-Host "3. Enterキーでの確定" -ForegroundColor Gray
Write-Host "4. カスタム設定の入力プロンプト" -ForegroundColor Gray
Write-Host "5. XMLファイルの正常な生成" -ForegroundColor Gray
```

---

## トラブルシューティング

### よくある問題と解決方法

#### 問題1: PowerShell実行ポリシーエラー
**症状**: 
```
.\Generate-UnattendXML.ps1 : このシステムではスクリプトの実行が無効になっているため、ファイル Generate-UnattendXML.ps1 を読み込めません。
```

**解決方法**:
```powershell
# 管理者権限でPowerShellを起動して実行
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

#### 問題2: モジュールインポートエラー
**症状**:
```
Import-Module : 指定されたモジュール 'Generate-UnattendXML.psm1' が読み込まれませんでした
```

**解決方法**:
```powershell
# ファイルの存在確認
Test-Path ".\Generate-UnattendXML.psm1"

# 権限の確認と修正
$Path = ".\Generate-UnattendXML.psm1"
$Acl = Get-Acl $Path
$Acl | Format-List

# ブロック解除
Unblock-File $Path
```

#### 問題3: .NETアセンブリ読み込みエラー
**症状**:
```
Add-Type : アセンブリまたはモジュール 'System.Xml' を読み込めませんでした
```

**解決方法**:
```powershell
# .NET Framework バージョン確認
[System.Environment]::Version

# Windows Updateの確認と適用
# .NET Framework 4.7.2以降をインストール
```

#### 問題4: ファイル出力権限エラー
**症状**:
```
Add-Content : パス 'C:\Tools\Windows11-UnattendXML-Generator\Logs\' へのアクセスが拒否されました
```

**解決方法**:
```powershell
# 出力ディレクトリの権限設定
$OutputPath = ".\Outputs"
$LogPath = ".\Logs"

foreach ($path in @($OutputPath, $LogPath)) {
    $Acl = Get-Acl $path
    $AccessRule = New-Object System.Security.AccessControl.FileSystemAccessRule(
        $env:USERNAME, "FullControl", "ContainerInherit,ObjectInherit", "None", "Allow"
    )
    $Acl.SetAccessRule($AccessRule)
    Set-Acl $path $Acl
}
```

### 診断スクリプト

#### システム診断スクリプト
```powershell
# 統合診断スクリプト
function Test-UnattendXMLGeneratorInstallation {
    Write-Host "=== Windows 11 UnattendXML Generator 診断 ===" -ForegroundColor Cyan
    
    # PowerShellバージョン確認
    Write-Host "PowerShell バージョン: $($PSVersionTable.PSVersion)" -ForegroundColor Green
    
    # 実行ポリシー確認
    Write-Host "実行ポリシー: $(Get-ExecutionPolicy)" -ForegroundColor Green
    
    # ファイル存在確認
    $RequiredFiles = @(
        "Generate-UnattendXML.ps1",
        "Generate-UnattendXML.psm1"
    )
    
    foreach ($file in $RequiredFiles) {
        if (Test-Path $file) {
            Write-Host "✅ $file" -ForegroundColor Green
        } else {
            Write-Host "❌ $file が見つかりません" -ForegroundColor Red
        }
    }
    
    # プリセット確認
    $PresetPath = ".\Configs\Presets\"
    $PresetFiles = @("Development.psd1", "Enterprise.psd1", "Minimal.psd1")
    
    foreach ($preset in $PresetFiles) {
        $fullPath = Join-Path $PresetPath $preset
        if (Test-Path $fullPath) {
            Write-Host "✅ $preset" -ForegroundColor Green
        } else {
            Write-Host "❌ $preset が見つかりません" -ForegroundColor Red
        }
    }
    
    Write-Host "=== 診断完了 ===" -ForegroundColor Cyan
}

# 診断実行
Test-UnattendXMLGeneratorInstallation
```

---

## アンインストール方法

### Step 1: ショートカットの削除
```powershell
# デスクトップショートカット削除
$DesktopShortcut = "$env:PUBLIC\Desktop\Windows11 UnattendXML Generator.lnk"
if (Test-Path $DesktopShortcut) {
    Remove-Item $DesktopShortcut -Force
    Write-Host "✅ デスクトップショートカットを削除しました" -ForegroundColor Green
}

# スタートメニューショートカット削除
$StartMenuShortcut = "$env:ProgramData\Microsoft\Windows\Start Menu\Programs\Administrative Tools\Windows11 UnattendXML Generator.lnk"
if (Test-Path $StartMenuShortcut) {
    Remove-Item $StartMenuShortcut -Force
    Write-Host "✅ スタートメニューショートカットを削除しました" -ForegroundColor Green
}
```

### Step 2: 環境変数の削除
```powershell
# PATH環境変数からの削除
$InstallPath = "C:\Tools\Windows11-UnattendXML-Generator"
$CurrentPath = [Environment]::GetEnvironmentVariable("Path", "Machine")
$NewPath = $CurrentPath -replace [regex]::Escape(";$InstallPath"), ""
[Environment]::SetEnvironmentVariable("Path", $NewPath, "Machine")
Write-Host "✅ PATH環境変数から削除しました" -ForegroundColor Green
```

### Step 3: PowerShellプロファイルのクリーンアップ
```powershell
# プロファイルからのモジュールインポート行削除
$ProfilePath = $PROFILE.AllUsersAllHosts
if (Test-Path $ProfilePath) {
    $ProfileContent = Get-Content $ProfilePath
    $CleanContent = $ProfileContent | Where-Object { $_ -notlike "*Generate-UnattendXML*" }
    $CleanContent | Set-Content $ProfilePath
    Write-Host "✅ PowerShellプロファイルをクリーンアップしました" -ForegroundColor Green
}
```

### Step 4: ファイルとフォルダの削除
```powershell
# インストールディレクトリの削除
if (Test-Path $InstallPath) {
    Remove-Item $InstallPath -Recurse -Force
    Write-Host "✅ インストールディレクトリを削除しました: $InstallPath" -ForegroundColor Green
} else {
    Write-Host "⚠️ インストールディレクトリが見つかりません: $InstallPath" -ForegroundColor Yellow
}

Write-Host "=== アンインストール完了 ===" -ForegroundColor Cyan
```

---

## 完了確認

インストールが正常に完了したら、以下のコマンドで動作確認を行ってください：

```powershell
# 基本的な動作テスト
.\Generate-UnattendXML.ps1 -PresetName "Development" -WhatIf

# 成功時の出力例:
# WhatIfモード: 実際の生成は行わず、処理内容のみ表示
# === 生成予定の設定内容 ===
# ホスト名: WIN11-DEV
# ユーザー数: 3
# IPv6無効化: True
# Firewall無効化: True
# 出力先: C:\Tools\Windows11-UnattendXML-Generator\Outputs\unattend_20250122_143052.xml
# ==========================
```

---

*このインストール手順書に従って、Windows 11 Sysprep応答ファイル自動生成システム（PowerShell版）を正常にインストールできます。問題が発生した場合は、トラブルシューティングセクションを参照してください。*