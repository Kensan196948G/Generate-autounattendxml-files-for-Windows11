# 運用ガイド

## 📋 概要

Windows 11 無人応答ファイル生成システムの本番環境での運用方法、ベストプラクティス、メンテナンス手順を説明します。

---

## 🎯 利用シナリオ

### 1. 企業環境での大量展開

#### ユースケース
- 新入社員用PC 50台のセットアップ
- 部署標準PCの展開
- リプレース作業の自動化

#### 推奨設定
```json
{
  "setupBehavior": {
    "skipMachineOOBE": true,
    "skipUserOOBE": true,
    "hideOnlineAccountScreens": true
  },
  "systemTweaks": {
    "disableTelemetry": true,
    "disableConsumerFeatures": true,
    "disableCortana": true
  },
  "computerSettings": {
    "joinDomain": true,
    "domain": "company.local",
    "domainOU": "OU=Computers,OU=Tokyo,DC=company,DC=local"
  }
}
```

### 2. 開発環境構築

#### ユースケース
- 開発者向けPC設定
- テスト環境の構築
- CI/CD環境の準備

#### 推奨設定
```json
{
  "vmSupport": {
    "enableHyperV": true,
    "enableWSL": true,
    "enableWSL2": true,
    "enableSandbox": true,
    "enableContainers": true
  },
  "additionalComponents": {
    "dotnet35": true,
    "dotnet48": true,
    "iis": true,
    "powershell2": false
  }
}
```

### 3. 教育機関向け

#### ユースケース
- 学生用PC設定
- コンピューター室の一括設定
- 試験環境の構築

#### 推奨設定
```json
{
  "userAccounts": {
    "accounts": [{
      "name": "student",
      "group": "Users",
      "autoLogon": true,
      "passwordNeverExpires": false
    }],
    "disableAdminAccount": true
  },
  "systemTweaks": {
    "disableWindowsStore": true,
    "disableGameBar": true
  }
}
```

---

## 🔄 日常運用

### 起動手順

#### 1. サービスとしての起動（推奨）
```powershell
# サービスの開始
Start-Service "WebUI-Backend"
Start-Service "WebUI-Frontend"

# 自動起動の設定
Set-Service "WebUI-Backend" -StartupType Automatic
Set-Service "WebUI-Frontend" -StartupType Automatic
```

#### 2. タスクスケジューラでの起動
```powershell
# タスクの作成
$action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-File E:\WebUI\Start-WebUI.ps1"
$trigger = New-ScheduledTaskTrigger -AtStartup
Register-ScheduledTask -TaskName "WebUI-AutoStart" -Action $action -Trigger $trigger -RunLevel Highest
```

### 停止手順

```powershell
# 通常の停止
.\WebUI\Stop-WebUI.ps1

# サービスの停止
Stop-Service "WebUI-Backend"
Stop-Service "WebUI-Frontend"
```

### 再起動手順

```powershell
# 自動再起動スクリプト
.\WebUI\Restart-Backend.ps1

# 手動再起動
Stop-Service "WebUI-Backend"
Start-Sleep -Seconds 5
Start-Service "WebUI-Backend"
```

---

## 📊 監視とログ管理

### ログファイルの場所

```
WebUI\
├── logs\
│   ├── backend\
│   │   ├── access.log      # アクセスログ
│   │   ├── error.log       # エラーログ
│   │   └── application.log # アプリケーションログ
│   └── frontend\
│       ├── build.log       # ビルドログ
│       └── runtime.log     # 実行時ログ
```

### ログローテーション設定

```powershell
# 日次ログローテーション
$logPath = "E:\WebUI\logs\backend"
$date = Get-Date -Format "yyyyMMdd"
Get-ChildItem "$logPath\*.log" | ForEach-Object {
    Move-Item $_.FullName "$($_.BaseName)_$date$($_.Extension)"
}

# 30日以前のログを削除
Get-ChildItem "$logPath\*_*.log" | Where-Object {
    $_.LastWriteTime -lt (Get-Date).AddDays(-30)
} | Remove-Item
```

### 監視項目

#### システムメトリクス
```powershell
# CPU使用率の監視
Get-Counter "\Process(python*)\% Processor Time"

# メモリ使用量の監視
Get-Counter "\Process(python*)\Working Set - Private"

# ディスク使用量
Get-PSDrive E | Select-Object Used,Free
```

#### アプリケーションメトリクス
```powershell
# APIレスポンスタイム
Measure-Command {
    Invoke-RestMethod -Uri "http://localhost:8081/api/health"
}

# アクティブなエージェント数
(Invoke-RestMethod -Uri "http://localhost:8081/api/agents").agents.Count
```

### アラート設定

```powershell
# エラー監視スクリプト
$errorLog = "E:\WebUI\logs\backend\error.log"
$lastPosition = 0

while ($true) {
    $content = Get-Content $errorLog -Tail 10
    if ($content -match "ERROR|CRITICAL") {
        # メール送信やTeams通知
        Send-MailMessage -To "admin@company.com" -Subject "WebUI Error Alert" -Body $content
    }
    Start-Sleep -Seconds 60
}
```

---

## 🔧 メンテナンス

### 定期メンテナンス項目

#### 週次タスク
1. ログファイルの確認
2. ディスク容量の確認
3. バックアップの実行
4. パフォーマンス確認

#### 月次タスク
1. セキュリティパッチの適用
2. 依存パッケージの更新
3. 設定ファイルの見直し
4. ドキュメントの更新

### バックアップ手順

```powershell
# バックアップスクリプト
$backupDate = Get-Date -Format "yyyyMMdd_HHmmss"
$backupPath = "E:\Backup\WebUI_$backupDate"

# 設定ファイルのバックアップ
Copy-Item -Path "E:\WebUI\configs" -Destination "$backupPath\configs" -Recurse
Copy-Item -Path "E:\WebUI\backend\*.py" -Destination "$backupPath\backend" -Recurse

# データベースのバックアップ（使用している場合）
# SQLiteの例
Copy-Item -Path "E:\WebUI\data\*.db" -Destination "$backupPath\data"

# ZIPアーカイブの作成
Compress-Archive -Path $backupPath -DestinationPath "$backupPath.zip"
```

### リストア手順

```powershell
# バックアップからのリストア
$backupFile = "E:\Backup\WebUI_20240824_120000.zip"
$restorePath = "E:\WebUI_Restore"

# 解凍
Expand-Archive -Path $backupFile -DestinationPath $restorePath

# ファイルの復元
Copy-Item -Path "$restorePath\*" -Destination "E:\WebUI" -Recurse -Force

# サービスの再起動
Restart-Service "WebUI-Backend", "WebUI-Frontend"
```

---

## 🚀 パフォーマンスチューニング

### バックエンド最適化

```python
# main.py の設定
import uvicorn

if __name__ == "__main__":
    uvicorn.run(
        "main:app",
        host="0.0.0.0",
        port=8081,
        workers=4,  # CPUコア数に応じて調整
        loop="uvloop",  # 高速化
        log_level="warning",  # ログレベル調整
        access_log=False  # アクセスログ無効化で高速化
    )
```

### フロントエンド最適化

```javascript
// next.config.js
module.exports = {
  reactStrictMode: true,
  compress: true,  // gzip圧縮有効化
  poweredByHeader: false,  // セキュリティ向上
  generateEtags: true,  // キャッシュ最適化
  
  // ビルド最適化
  webpack: (config, { buildId, dev, isServer, defaultLoaders, webpack }) => {
    config.optimization.minimize = true;
    return config;
  },
}
```

### データベース最適化（将来の拡張用）

```sql
-- インデックスの作成
CREATE INDEX idx_config_created ON configurations(created_at);
CREATE INDEX idx_config_user ON configurations(user_id);

-- 定期的なVACUUM（SQLite）
VACUUM;
ANALYZE;
```

---

## 🔐 セキュリティ運用

### アクセス制御

```powershell
# IPアドレス制限
New-NetFirewallRule -DisplayName "WebUI Allow Internal" `
    -Direction Inbound -LocalPort 8081,3050 -Protocol TCP `
    -RemoteAddress "192.168.0.0/16" -Action Allow

# 外部アクセスのブロック
New-NetFirewallRule -DisplayName "WebUI Block External" `
    -Direction Inbound -LocalPort 8081,3050 -Protocol TCP `
    -RemoteAddress "0.0.0.0/0" -Action Block
```

### SSL/TLS設定

```nginx
# nginx設定例（リバースプロキシ使用時）
server {
    listen 443 ssl http2;
    server_name webui.company.local;
    
    ssl_certificate /etc/ssl/certs/webui.crt;
    ssl_certificate_key /etc/ssl/private/webui.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    
    location / {
        proxy_pass http://localhost:3050;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    location /api {
        proxy_pass http://localhost:8081;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 監査ログ

```python
# 監査ログの実装例
import logging
from datetime import datetime

audit_logger = logging.getLogger('audit')

def log_xml_generation(user, config, result):
    audit_logger.info({
        'timestamp': datetime.now().isoformat(),
        'user': user,
        'action': 'generate_xml',
        'config_hash': hash(str(config)),
        'result': result,
        'ip_address': request.client.host
    })
```

---

## 📈 容量計画

### ディスク使用量の見積もり

| 項目 | サイズ | 説明 |
|------|--------|------|
| アプリケーション | 500MB | WebUI本体 |
| ログファイル | 100MB/月 | ローテーション前提 |
| 生成XMLファイル | 50KB/ファイル | 一時保存 |
| バックアップ | 1GB/世代 | 圧縮後 |

### スケーリング計画

```yaml
# 負荷に応じたスケーリング
小規模（〜100台/月）:
  - サーバー: 1台
  - CPU: 2コア
  - メモリ: 4GB
  
中規模（100-500台/月）:
  - サーバー: 1台
  - CPU: 4コア
  - メモリ: 8GB
  
大規模（500台以上/月）:
  - サーバー: 2台（冗長化）
  - CPU: 8コア
  - メモリ: 16GB
  - ロードバランサー導入
```

---

## 🔄 アップデート管理

### アップデート手順

```powershell
# 1. バックアップの作成
.\Scripts\Backup-WebUI.ps1

# 2. サービスの停止
Stop-Service "WebUI-Backend", "WebUI-Frontend"

# 3. ファイルの更新
git pull origin main
# または
Expand-Archive -Path "update_v2.0.0.zip" -DestinationPath "E:\WebUI" -Force

# 4. 依存関係の更新
cd WebUI\backend
pip install -r requirements.txt --upgrade

cd ..\frontend
npm update

# 5. データベースマイグレーション（必要な場合）
python manage.py migrate

# 6. サービスの再起動
Start-Service "WebUI-Backend", "WebUI-Frontend"

# 7. 動作確認
Invoke-RestMethod -Uri "http://localhost:8081/api/health"
```

### ロールバック手順

```powershell
# バックアップからの復元
.\Scripts\Restore-WebUI.ps1 -BackupDate "20240824_120000"
```

---

## 📊 レポート作成

### 利用統計レポート

```powershell
# 月次レポート生成
$startDate = Get-Date -Day 1
$endDate = Get-Date

$stats = @{
    TotalGenerations = (Get-Content logs\access.log | Select-String "generate-unattend").Count
    UniqueUsers = (Get-Content logs\access.log | Select-String -Pattern '\d+\.\d+\.\d+\.\d+' -AllMatches).Matches.Value | Select-Object -Unique | Measure-Object
    ErrorCount = (Get-Content logs\error.log | Select-String "ERROR").Count
    AverageResponseTime = # APIレスポンスタイムの集計
}

$stats | ConvertTo-Html | Out-File "reports\monthly_$(Get-Date -Format 'yyyyMM').html"
```

---

## 🆘 サポート体制

### レベル1サポート（ユーザーサポート）
- 使い方の問い合わせ
- 設定値の確認
- 簡単なトラブルシューティング

### レベル2サポート（システム管理者）
- サービスの再起動
- ログの確認
- 設定ファイルの修正

### レベル3サポート（開発チーム）
- バグ修正
- 機能追加
- アーキテクチャ変更

---

## 📝 チェックリスト

### 日次チェック
- [ ] サービス稼働状態
- [ ] エラーログ確認
- [ ] ディスク容量確認

### 週次チェック
- [ ] パフォーマンス確認
- [ ] バックアップ実行
- [ ] セキュリティログ確認

### 月次チェック
- [ ] アップデート確認
- [ ] 容量計画見直し
- [ ] ドキュメント更新

---

*最終更新: 2024年8月24日*