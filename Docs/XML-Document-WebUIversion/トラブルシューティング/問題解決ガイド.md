# Windows 11 Sysprep WebUI トラブルシューティングガイド

## 🔧 よくある問題と解決方法

## 目次

1. [起動時の問題](#起動時の問題)
2. [接続・アクセスの問題](#接続アクセスの問題)
3. [XML生成の問題](#xml生成の問題)
4. [ダウンロードの問題](#ダウンロードの問題)
5. [設定が反映されない問題](#設定が反映されない問題)
6. [エラーメッセージ一覧](#エラーメッセージ一覧)
7. [ログファイルの確認方法](#ログファイルの確認方法)

## 起動時の問題

### 問題: PowerShellスクリプトが実行できない

**症状:**
```
スクリプトの実行がシステムで無効になっているため、ファイル xxx.ps1 を読み込めません
```

**解決方法:**
```powershell
# 管理者権限でPowerShellを開き、実行
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force

# または、修復スクリプトを実行
.\Fix-ExecutionPolicy.ps1
```

### 問題: ポート8081/3050が既に使用されている

**症状:**
```
[Errno 10048] error while attempting to bind on address ('0.0.0.0', 8081)
```

**解決方法:**
```powershell
# ポート競合を解決
.\Fix-Port-Conflict.ps1

# または手動で確認
netstat -ano | findstr :8081
# プロセスIDを確認してkill
taskkill /PID [プロセスID] /F
```

### 問題: Pythonモジュールが見つからない

**症状:**
```
ModuleNotFoundError: No module named 'fastapi'
```

**解決方法:**
```powershell
# 依存関係を再インストール
cd WebUI\backend
pip install -r requirements.txt

# または自動修復
.\Auto-Fix-All-Simple.ps1 -Verbose
```

### 問題: Node.jsモジュールが見つからない

**症状:**
```
Module not found: Can't resolve 'axios'
```

**解決方法:**
```powershell
cd WebUI\frontend
npm install

# キャッシュクリア後に再インストール
npm cache clean --force
npm install
```

## 接続・アクセスの問題

### 問題: ブラウザでアクセスできない

**症状:**
- ページが表示されない
- "このサイトにアクセスできません"

**解決方法:**

1. **サービスの起動確認**
```powershell
.\Test-Connection.ps1
```

2. **正しいIPアドレスの確認**
```powershell
.\Test-IPDetection.ps1
# 表示されたIPアドレスを使用
```

3. **ファイアウォールの確認**
```powershell
# Windows Defenderファイアウォールに例外追加
New-NetFirewallRule -DisplayName "WebUI Backend" -Direction Inbound -LocalPort 8081 -Protocol TCP -Action Allow
New-NetFirewallRule -DisplayName "WebUI Frontend" -Direction Inbound -LocalPort 3050 -Protocol TCP -Action Allow
```

4. **別のブラウザで試す**
- Chrome, Edge, Firefox など

### 問題: CORSエラー

**症状:**
```
Access to XMLHttpRequest at 'http://xxx:8081' from origin 'http://xxx:3050' has been blocked by CORS policy
```

**解決方法:**
```powershell
# バックエンドを再起動
.\Restart-Backend.ps1

# main.pyのCORS設定を確認
# allowed_originsにアクセス元のURLが含まれているか確認
```

## XML生成の問題

### 問題: XML生成エラー

**症状:**
```
XML生成エラー
メッセージ: APIエラーが発生しました
```

**解決方法:**

1. **必須項目の確認**
   - Windowsエディションが選択されているか
   - ユーザーアカウントが設定されているか
   - パスワードが8文字以上か

2. **バックエンドログの確認**
```powershell
# ログファイルを確認
Get-Content WebUI\logs\backend.log -Tail 50
```

3. **設定データの検証**
   - ブラウザの開発者ツール（F12）でコンソールエラーを確認
   - ネットワークタブでリクエスト内容を確認

### 問題: 生成されたXMLが不完全

**症状:**
- 設定した項目が反映されていない
- XMLファイルが壊れている

**解決方法:**

1. **設定変換の確認**
```powershell
# テストスクリプトを実行
cd WebUI\backend
python test_xml_generator.py
```

2. **XMLバリデーション**
```powershell
# PowerShellでXMLを検証
[xml]$xml = Get-Content autounattend.xml
$xml.Save("validated.xml")
```

## ダウンロードの問題

### 問題: ファイルがダウンロードされない

**症状:**
- ボタンをクリックしても何も起こらない
- ダウンロードが開始されない

**解決方法:**

1. **ブラウザの設定確認**
   - ポップアップブロッカーを無効化
   - ダウンロードフォルダの権限確認

2. **別の方法でダウンロード**
```powershell
# curlでダウンロード
curl -X POST http://localhost:8081/api/generate-unattend `
  -H "Content-Type: application/json" `
  -d '{"windows_edition":"Pro"}' `
  --output autounattend.xml
```

### 問題: ZIPファイルが破損している

**症状:**
- ZIPファイルが開けない
- "アーカイブが壊れています"

**解決方法:**

1. **ダウンロードを再試行**
2. **別のツールで解凍**
   - 7-Zip
   - WinRAR
3. **PowerShellで解凍**
```powershell
Expand-Archive -Path unattend_package.zip -DestinationPath extracted
```

## 設定が反映されない問題

### 問題: Wi-Fi設定が含まれない

**確認事項:**
1. "次の設定を使用してWi-Fiを構成します"が選択されているか
2. SSIDとパスワードが入力されているか

**解決方法:**
- バックエンドのconfig_transformer.pyが正しく動作しているか確認

### 問題: ユーザーアカウントが作成されない

**確認事項:**
1. パスワードが要件を満たしているか（8文字以上）
2. ユーザー名に使用できない文字が含まれていないか

**解決方法:**
```xml
<!-- 生成されたXMLでLocalAccountsセクションを確認 -->
<LocalAccounts>
  <LocalAccount>
    <Password>
      <Value>エンコードされたパスワード</Value>
      <PlainText>false</PlainText>
    </Password>
    <Name>ユーザー名</Name>
  </LocalAccount>
</LocalAccounts>
```

## エラーメッセージ一覧

| エラーメッセージ | 原因 | 解決方法 |
|----------------|------|----------|
| Network Error | バックエンドに接続できない | サービスの起動確認 |
| 404 Not Found | エンドポイントが存在しない | URLの確認 |
| 422 Unprocessable Entity | リクエストデータが不正 | 入力内容の確認 |
| 500 Internal Server Error | サーバーエラー | ログファイル確認 |
| CORS Error | CORS設定の問題 | バックエンド再起動 |
| Failed to fetch | ネットワーク接続エラー | ファイアウォール確認 |

## ログファイルの確認方法

### バックエンドログ

```powershell
# 最新のログを表示
Get-Content WebUI\logs\backend.log -Tail 100

# エラーのみ抽出
Select-String -Path WebUI\logs\backend.log -Pattern "ERROR"

# リアルタイムで監視
Get-Content WebUI\logs\backend.log -Wait
```

### フロントエンドログ

ブラウザの開発者ツール（F12）で確認：
1. コンソールタブ - JavaScriptエラー
2. ネットワークタブ - APIリクエスト/レスポンス
3. アプリケーションタブ - ローカルストレージ

### システムログ

```powershell
# Windows イベントログを確認
Get-EventLog -LogName Application -Newest 50 | Where-Object {$_.Source -like "*Python*" -or $_.Source -like "*Node*"}
```

## 高度なトラブルシューティング

### デバッグモードで起動

```powershell
# バックエンドをデバッグモードで起動
cd WebUI\backend
$env:DEBUG = "true"
python main.py

# フロントエンドをデバッグモードで起動
cd WebUI\frontend
$env:NODE_ENV = "development"
npm run dev
```

### ネットワークトレース

```powershell
# パケットキャプチャ
netsh trace start capture=yes tracefile=network.etl provider=Microsoft-Windows-TCPIP

# 停止
netsh trace stop
```

### プロセス監視

```powershell
# CPUとメモリ使用率を監視
Get-Process python, node | Select-Object Name, CPU, WorkingSet64
```

## サポート情報

### ログ収集スクリプト

問題報告時に必要な情報を収集：

```powershell
# サポート情報収集
$supportInfo = @{
    "OS" = (Get-CimInstance Win32_OperatingSystem).Caption
    "Python" = python --version
    "Node" = node --version
    "NPM" = npm --version
    "CurrentTime" = Get-Date
    "Services" = Get-Process python, node -ErrorAction SilentlyContinue
}

$supportInfo | ConvertTo-Json | Out-File support_info.json
Write-Host "サポート情報を support_info.json に保存しました"
```

### 問題報告テンプレート

GitHubで問題を報告する際のテンプレート：

```markdown
## 問題の概要
[問題を簡潔に説明]

## 再現手順
1. [手順1]
2. [手順2]
3. [手順3]

## 期待される動作
[正常な場合の動作]

## 実際の動作
[現在の動作]

## 環境情報
- OS: Windows 11
- Python: 3.x.x
- Node.js: 18.x.x
- ブラウザ: Chrome/Edge/Firefox

## ログ
```
[関連するログを貼り付け]
```

## スクリーンショット
[可能であれば添付]
```

## リセット・再インストール

### 完全リセット

すべてを初期状態に戻す：

```powershell
# 1. サービスを停止
.\Stop-WebUI.ps1

# 2. キャッシュとログを削除
Remove-Item WebUI\logs\* -Force
Remove-Item WebUI\frontend\.next -Recurse -Force
Remove-Item WebUI\frontend\node_modules -Recurse -Force
Remove-Item WebUI\backend\__pycache__ -Recurse -Force

# 3. 再インストール
.\Auto-Fix-All-Simple.ps1 -Verbose
```

---

*最終更新: 2025年8月24日*