# Windows 11 Sysprep WebUI システム詳細仕様書
## バージョン 2.0 - 全23項目完全対応版

## 1. システム構成

### 1.1 技術スタック

#### バックエンド
- **言語**: Python 3.10+
- **フレームワーク**: FastAPI 0.104.1
- **サーバー**: Uvicorn (ASGI)
- **XML処理**: xml.etree.ElementTree
- **非同期処理**: asyncio

#### フロントエンド
- **フレームワーク**: Next.js 14.0.4
- **言語**: TypeScript 5.3.3
- **UIライブラリ**: React 18.2.0
- **HTTP通信**: Axios 1.6.2
- **スタイリング**: CSS Modules

### 1.2 システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                    ユーザーブラウザ                       │
└────────────────────┬────────────────────────────────────┘
                     │ HTTP/HTTPS
                     ▼
┌─────────────────────────────────────────────────────────┐
│              フロントエンド (Port 3050)                   │
│                   Next.js / React                        │
│  ┌──────────────────────────────────────────────────┐   │
│  │  設定UI  │  プレビュー  │  ダウンロード管理      │   │
│  └──────────────────────────────────────────────────┘   │
└────────────────────┬────────────────────────────────────┘
                     │ REST API
                     ▼
┌─────────────────────────────────────────────────────────┐
│              バックエンド (Port 8081)                     │
│                     FastAPI                              │
│  ┌──────────────────────────────────────────────────┐   │
│  │  APIルーター  │  設定変換  │  XML生成  │  ログ生成│   │
│  └──────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────┐   │
│  │           SubAgent システム (42体)                 │   │
│  │  ユーザー管理 │ ネットワーク │ セキュリティ etc. │   │
│  └──────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────┐   │
│  │         Context7 エンジン                         │   │
│  │    コンテキスト管理 │ 状態追跡 │ 最適化         │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

## 2. モジュール仕様

### 2.1 バックエンドモジュール

#### main.py
- **機能**: FastAPIサーバーのエントリーポイント
- **責務**: 
  - APIエンドポイントの定義
  - CORS設定
  - リクエスト/レスポンス処理

#### enhanced_xml_generator.py
- **機能**: 拡張XML生成エンジン
- **主要メソッド**:
  - `generate_complete_xml()`: 完全なXML生成
  - `_encode_password()`: パスワードのBase64エンコード（UTF-16LE）
  - `_add_wifi_config()`: Wi-Fi設定の追加

#### config_transformer.py
- **機能**: フロントエンド設定をバックエンド形式に変換
- **変換処理**:
  - Windowsエディション名の正規化
  - ユーザーアカウント形式の変換
  - Wi-Fi設定の抽出と変換

#### config_log_generator.py
- **機能**: 日本語設定ログの生成
- **出力形式**: UTF-8テキストファイル
- **ログセクション**:
  - 基本設定
  - Windowsエディション
  - ユーザーアカウント
  - ネットワーク設定
  - Windows機能
  - システム設定

### 2.2 フロントエンドモジュール

#### pages/index.tsx
- **機能**: メインUIページ
- **コンポーネント構成**:
  - 設定入力フォーム（23セクション）
  - リアルタイムバリデーション
  - ダウンロードボタン（XML/ZIP）

#### services/api.ts
- **機能**: バックエンドAPI通信
- **主要メソッド**:
  - `generateXml()`: XML生成リクエスト
  - `downloadXml()`: XMLダウンロード
  - `downloadXmlWithLog()`: ZIP（XML+ログ）ダウンロード

## 3. APIエンドポイント仕様

### 3.1 XML生成エンドポイント

#### POST /api/generate-unattend
- **目的**: unattend.xmlの生成
- **リクエスト**: JSON（設定オブジェクト）
- **レスポンス**: application/xml
- **ステータスコード**:
  - 200: 成功
  - 400: 不正なリクエスト
  - 500: サーバーエラー

#### POST /api/generate-with-log
- **目的**: XML + 設定ログのZIP生成
- **リクエスト**: JSON（設定オブジェクト）
- **レスポンス**: application/zip
- **ファイル構成**:
  - autounattend.xml
  - 設定ログ.txt

### 3.2 システム管理エンドポイント

#### GET /api/status
- **目的**: システム状態の取得
- **レスポンス**: 
  ```json
  {
    "status": "running",
    "version": "2.0.0",
    "backend_ip": "192.168.x.x",
    "timestamp": "2025-08-24T00:00:00"
  }
  ```

#### GET /api/health
- **目的**: ヘルスチェック
- **レスポンス**: システムメトリクス

## 4. データフロー

### 4.1 XML生成フロー

```
1. ユーザー入力（フロントエンド）
   ↓
2. 設定データのバリデーション
   ↓
3. APIリクエスト送信（axios）
   ↓
4. 設定変換（config_transformer）
   ↓
5. XML生成（enhanced_xml_generator）
   ↓
6. レスポンス返送
   ↓
7. ファイルダウンロード（ブラウザ）
```

### 4.2 ログ生成フロー

```
1. 設定データ受信
   ↓
2. 日本語ログ生成（config_log_generator）
   ↓
3. XMLと同時にZIP圧縮
   ↓
4. バイナリストリームとして返送
```

## 5. セキュリティ仕様

### 5.1 パスワード処理
- **エンコーディング**: Base64（UTF-16LE + "Password"サフィックス）
- **保存**: XMLに暗号化形式で保存
- **ログ**: "設定済み"として表示（平文非表示）

### 5.2 CORS設定
- **許可オリジン**: 設定されたIPアドレスとポートのみ
- **許可メソッド**: GET, POST, OPTIONS
- **認証**: 現在は未実装（将来的にJWT対応予定）

## 6. エラーハンドリング

### 6.1 バックエンド
- HTTPException による統一的なエラーレスポンス
- 詳細なエラーログ記録
- スタックトレースの保存

### 6.2 フロントエンド
- Axiosインターセプターによるエラーキャッチ
- ユーザーフレンドリーなエラーメッセージ表示
- 自動リトライ機能（ネットワークエラー時）

## 7. パフォーマンス最適化

### 7.1 並列処理
- SubAgent（42体）による並列タスク実行
- asyncio による非同期処理
- Context7による効率的なメモリ管理

### 7.2 キャッシュ
- 静的リソースのブラウザキャッシュ
- APIレスポンスの条件付きキャッシュ

## 8. 拡張性

### 8.1 プラグインアーキテクチャ
- 新規SubAgentの追加が容易
- 設定項目の動的追加対応
- カスタムバリデーターの追加可能

### 8.2 国際化対応
- 現在: 日本語完全対応
- 将来: 多言語対応可能な構造

## 9. テスト仕様

### 9.1 単体テスト
- pytest によるバックエンドテスト
- Jest によるフロントエンドテスト

### 9.2 統合テスト
- エンドツーエンドテスト
- Playwright による自動UIテスト

## 10. デプロイメント

### 10.1 開発環境
- ローカルIP自動検出
- ホットリロード対応
- デバッグモード

### 10.2 本番環境
- HTTPS対応（証明書設定）
- リバースプロキシ対応（nginx）
- ログローテーション

---

*最終更新: 2025年8月24日*