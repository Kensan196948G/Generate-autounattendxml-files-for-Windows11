# トラブルシューティングガイド

## 🔍 概要

Windows 11 無人応答ファイル生成システムで発生する可能性のある問題と、その解決方法を説明します。

---

## ⚠️ よくある問題と解決方法

### 1. 起動時の問題

#### 🔴 問題: PowerShellスクリプトが実行できない

**エラーメッセージ:**
```
このシステムではスクリプトの実行が無効になっているため、ファイル Start-WebUI.ps1 を読み込むことができません
```

**解決方法:**
```powershell
# 管理者権限でPowerShellを開いて実行
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force

# または一時的に許可
Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process -Force
```

#### 🔴 問題: ポート8081/3050が使用中

**エラーメッセージ:**
```
[ERROR] bind(): Address already in use
```

**解決方法:**
```powershell
# 使用中のプロセスを確認
netstat -ano | findstr :8081
netstat -ano | findstr :3050

# プロセスを終了（PIDを確認して）
taskkill /PID [プロセスID] /F

# または自動修復スクリプトを実行
.\WebUI\Quick-Fix-Ports.ps1
```

#### 🔴 問題: Python/Node.jsが見つからない

**エラーメッセージ:**
```
'python' は、内部コマンドまたは外部コマンド、操作可能なプログラムまたはバッチ ファイルとして認識されていません
```

**解決方法:**
```powershell
# Pythonのインストール確認
python --version
# または
py --version

# Node.jsのインストール確認
node --version

# パスの追加（Pythonの例）
[Environment]::SetEnvironmentVariable("Path", "$env:Path;C:\Python310", "User")

# パスの追加（Node.jsの例）
[Environment]::SetEnvironmentVariable("Path", "$env:Path;C:\Program Files\nodejs", "User")
```

---

### 2. API通信の問題

#### 🔴 問題: Network Error / Failed to fetch

**エラーメッセージ:**
```
XML生成エラー メッセージ: Network Error
Failed to fetch
```

**解決方法:**

1. **バックエンドの起動確認**
```powershell
# バックエンドの稼働確認
Invoke-RestMethod -Uri "http://localhost:8081/api/health"

# 起動していない場合
cd WebUI\backend
python main.py
```

2. **CORS設定の確認**
```python
# backend/main.py
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3050", "http://192.168.3.92:3050"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

3. **ファイアウォールの確認**
```powershell
# Windows Defenderファイアウォールの例外追加
New-NetFirewallRule -DisplayName "WebUI API" -Direction Inbound -LocalPort 8081 -Protocol TCP -Action Allow
```

#### 🔴 問題: 404 Not Found

**エラーメッセージ:**
```
APIエラーが発生しました ステータス: 404
```

**解決方法:**
```javascript
// frontend/src/services/api.ts
const API_BASE_URL = 'http://localhost:8081';

// エンドポイントの確認
const response = await fetch(`${API_BASE_URL}/api/generate-unattend`, {
  // 正しいパスを使用
});
```

#### 🔴 問題: 500 Internal Server Error

**エラーメッセージ:**
```
Internal Server Error
```

**解決方法:**

1. **バックエンドログの確認**
```powershell
# エラーログの確認
Get-Content WebUI\backend\logs\error.log -Tail 50
```

2. **依存関係の確認**
```powershell
cd WebUI\backend
pip list | Select-String "fastapi|uvicorn|pydantic"

# 不足している場合
pip install -r requirements.txt
```

---

### 3. XML生成の問題

#### 🔴 問題: 生成されたXMLが不完全

**症状:**
- 設定した項目がXMLに反映されない
- FirstLogonCommandsが生成されない

**解決方法:**

1. **設定データの確認**
```javascript
// ブラウザのコンソールで確認
console.log(JSON.stringify(config, null, 2));
```

2. **バックエンドの更新**
```powershell
# 最新のコードを反映
cd WebUI\backend
# バックエンドを再起動
Restart-Service "WebUI-Backend"
# または
python main.py
```

#### 🔴 問題: パスワードが正しくエンコードされない

**症状:**
- Windowsインストール時にパスワードが拒否される

**解決方法:**
```python
# 正しいエンコーディング（UTF-16LE + Base64）
import base64

def encode_password(password):
    password_with_suffix = password + "Password"
    encoded = base64.b64encode(password_with_suffix.encode('utf-16-le')).decode('ascii')
    return encoded
```

#### 🔴 問題: 日本語が文字化けする

**症状:**
- 日本語ログファイルが文字化け
- XMLファイル内の日本語が正しく表示されない

**解決方法:**
```python
# UTF-8エンコーディングを明示
with open('configuration_log.txt', 'w', encoding='utf-8') as f:
    f.write(log_content)

# XMLのエンコーディング宣言
<?xml version="1.0" encoding="utf-8"?>
```

---

### 4. フロントエンドの問題

#### 🔴 問題: ページが表示されない

**エラーメッセージ:**
```
This site can't be reached
localhost refused to connect
```

**解決方法:**
```powershell
# フロントエンドの起動確認
cd WebUI\frontend
npm run dev

# ポート3050の確認
netstat -an | findstr :3050
```

#### 🔴 問題: モジュールが見つからない

**エラーメッセージ:**
```
Module not found: Can't resolve 'axios'
```

**解決方法:**
```powershell
cd WebUI\frontend
# node_modulesの再インストール
Remove-Item node_modules -Recurse -Force -ErrorAction SilentlyContinue
Remove-Item package-lock.json -Force -ErrorAction SilentlyContinue
npm install
```

#### 🔴 問題: ビルドエラー

**エラーメッセージ:**
```
Failed to compile
Type error: Cannot find module
```

**解決方法:**
```powershell
# TypeScriptの型定義を再生成
cd WebUI\frontend
npm run build

# キャッシュのクリア
Remove-Item .next -Recurse -Force -ErrorAction SilentlyContinue
npm run dev
```

---

### 5. パフォーマンスの問題

#### 🔴 問題: レスポンスが遅い

**症状:**
- XML生成に時間がかかる
- UIの反応が遅い

**解決方法:**

1. **ワーカー数の調整**
```python
# backend/main.py
if __name__ == "__main__":
    uvicorn.run("main:app", workers=4)  # CPUコア数に応じて調整
```

2. **不要なログの無効化**
```python
# ログレベルの調整
logging.getLogger("uvicorn.access").disabled = True
```

3. **フロントエンドの最適化**
```powershell
cd WebUI\frontend
npm run build
npm run start  # 本番モードで起動
```

#### 🔴 問題: メモリ使用量が多い

**症状:**
- システムメモリが不足
- プロセスが応答しなくなる

**解決方法:**
```powershell
# メモリ使用量の確認
Get-Process python*, node* | Select-Object Name, WorkingSet64, CPU

# プロセスの再起動
Restart-Service "WebUI-Backend", "WebUI-Frontend"
```

---

### 6. 設定項目の問題

#### 🔴 問題: 特定の設定が反映されない

**症状:**
- 項目12-23の新機能が動作しない
- FirstLogonCommandsが不完全

**解決方法:**

1. **comprehensive_xml_generator.pyの確認**
```python
# 全23項目が実装されているか確認
def _build_comprehensive_first_logon_commands(self, component, config):
    # 項目12-23の実装を確認
```

2. **設定プロセッサーの確認**
```python
# comprehensive_config_processor.pyで変換が正しいか確認
def process(self, frontend_config):
    # 全項目の処理を確認
```

#### 🔴 問題: Wi-Fi設定が適用されない

**症状:**
- Wi-Fi自動接続が機能しない

**解決方法:**
```xml
<!-- 正しいXML構造を確認 -->
<component name="Microsoft-Windows-WiFi-Client-Intel-Netwbw02">
    <WLANProfile>
        <SSID>20mirai18</SSID>
        <Authentication>WPA2PSK</Authentication>
        <Encryption>AES</Encryption>
    </WLANProfile>
</component>
```

---

## 🛠️ 診断ツール

### システム診断スクリプト

```powershell
# 診断スクリプトの作成
@'
Write-Host "=== WebUI System Diagnostic ===" -ForegroundColor Cyan

# Python確認
Write-Host "`nPython Status:" -ForegroundColor Yellow
try {
    $pythonVersion = python --version 2>&1
    Write-Host "  ✓ Python: $pythonVersion" -ForegroundColor Green
} catch {
    Write-Host "  ✗ Python not found" -ForegroundColor Red
}

# Node.js確認
Write-Host "`nNode.js Status:" -ForegroundColor Yellow
try {
    $nodeVersion = node --version
    Write-Host "  ✓ Node.js: $nodeVersion" -ForegroundColor Green
} catch {
    Write-Host "  ✗ Node.js not found" -ForegroundColor Red
}

# ポート確認
Write-Host "`nPort Status:" -ForegroundColor Yellow
$port8081 = Test-NetConnection -ComputerName localhost -Port 8081 -InformationLevel Quiet
$port3050 = Test-NetConnection -ComputerName localhost -Port 3050 -InformationLevel Quiet

if ($port8081) {
    Write-Host "  ✓ Backend (8081): Active" -ForegroundColor Green
} else {
    Write-Host "  ✗ Backend (8081): Inactive" -ForegroundColor Red
}

if ($port3050) {
    Write-Host "  ✓ Frontend (3050): Active" -ForegroundColor Green
} else {
    Write-Host "  ✗ Frontend (3050): Inactive" -ForegroundColor Red
}

# API確認
Write-Host "`nAPI Status:" -ForegroundColor Yellow
try {
    $health = Invoke-RestMethod -Uri "http://localhost:8081/api/health" -ErrorAction Stop
    Write-Host "  ✓ API: Healthy" -ForegroundColor Green
} catch {
    Write-Host "  ✗ API: Not responding" -ForegroundColor Red
}
'@ | Out-File -FilePath "WebUI\Diagnose-System.ps1" -Encoding UTF8

# 診断の実行
.\WebUI\Diagnose-System.ps1
```

### ログ分析ツール

```powershell
# エラーログの分析
function Analyze-Logs {
    param(
        [string]$LogPath = "WebUI\backend\logs",
        [int]$Hours = 24
    )
    
    $since = (Get-Date).AddHours(-$Hours)
    $errors = Get-ChildItem "$LogPath\*.log" | ForEach-Object {
        Get-Content $_ | Select-String "ERROR|CRITICAL" | Where-Object {
            $_.Line -match '(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})' -and
            [datetime]$matches[1] -gt $since
        }
    }
    
    $errors | Group-Object -Property Line | Sort-Object Count -Descending | 
        Select-Object -First 10 Count, Name
}

Analyze-Logs
```

---

## 📞 サポート連絡先

### 問題が解決しない場合

1. **GitHub Issues**
   - URL: https://github.com/your-org/repo/issues
   - テンプレートに従って報告

2. **ログの収集**
```powershell
# サポート用ログ収集
$supportPackage = "WebUI_Support_$(Get-Date -Format 'yyyyMMdd_HHmmss').zip"
Compress-Archive -Path @(
    "WebUI\backend\logs",
    "WebUI\frontend\.next\trace",
    "WebUI\configs"
) -DestinationPath $supportPackage
```

3. **必要な情報**
   - エラーメッセージの全文
   - 再現手順
   - システム環境（OS、Python、Node.jsバージョン）
   - 設定内容（機密情報は除く）

---

## 🔄 自動修復スクリプト

```powershell
# 総合的な自動修復
.\WebUI\Auto-Fix-All.ps1

# 個別の修復
.\WebUI\Fix-ExecutionPolicy.ps1    # 実行ポリシー
.\WebUI\Quick-Fix-Ports.ps1        # ポート競合
.\WebUI\Auto-Fix-Backend.ps1       # バックエンド
```

---

## 📚 参考リンク

- [FastAPI トラブルシューティング](https://fastapi.tiangolo.com/tutorial/debugging/)
- [Next.js エラーハンドリング](https://nextjs.org/docs/basic-features/error-handling)
- [Windows Sysprep リファレンス](https://docs.microsoft.com/windows-hardware/manufacture/desktop/sysprep-reference)

---

*最終更新: 2024年8月24日*